<?
//  mark
include (\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Access_Backend::checkAccess("modules_admin");

Admin_Html::loadAdminHeader();

DB::addField('community_whoisonline',  'referrer', 'VARCHAR( 255 ) NOT NULL', 'ip');

if($_POST['action'] == "save") {
	foreach($_POST as $key=>$val) {
		db_query($db_data['system'], "DELETE FROM system_config WHERE c_key = '".$key."'");
		db_query($db_data['system'], "INSERT INTO system_config SET c_value = '".$val."', c_key = '".$key."'");
	}
}

if($_POST['action'] == "config") {
	$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
	$config->ftime = $_VARS['ftime'];
	$config->oneself = $_VARS['oneself'];
	$config->save_config($_VARS['page_id'], $_VARS['element_id']);
}

$my1 = get_data(db_query($db_data['system'], "SELECT * FROM system_config WHERE c_key = 'whoisonline_valid'"));
$my2 = get_data(db_query($db_data['system'], "SELECT * FROM system_config WHERE c_key = 'whoisonline_active'"));
$my3 = get_data(db_query($db_data['system'], "SELECT * FROM system_config WHERE c_key = 'whoisonline_recordall'"));

?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
	<tr>
		<td valign="top">
			<h1>Community &raquo; Wer ist online?</h1>
			<p>
<?

$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

if($_VARS['page_id'] && $_VARS['element_id']) {
?>
			<form method="POST" action="community_whoisonline.html">
			<input type="hidden" name="action" value="config">
			<input type="hidden" name="page_id" value="<?=$_VARS['page_id']?>">
			<input type="hidden" name="element_id" value="<?=$_VARS['element_id']?>">
			<?=printTableStart()?>
			<?=printFormText("Format der Zeitangabe (strftime-Parameter)", "ftime", $config->ftime)?>
			<?=printFormSelect("Eigenen Benutzer auflisten?","oneself",array("0"=>"Nein","1"=>"Ja"), $config->oneself)?>
			<?=printTableEnd()?>
			<?=printSubmit("Konfiguration speichern")?>
			</form>		
<?
} else {
?>
			<h2>Einstellungen</h2>
			<form method="POST" action="community_whoisonline.html">
			<input type="hidden" name="action" value="save">
			<?=printTableStart()?>
			<?=printFormSelect("Funktion aktiv", "whoisonline_active", array("1"=>"Ja","0"=>"Nein"), $my2['c_value'])?>
			<?=printFormText("Ablaufzeit in Sekunden", "whoisonline_valid", $my1['c_value'])?>
			<?=printFormSelect("Zeige", "whoisonline_recordall", array("1"=>"Alle Besucher","0"=>"Nur angemeldete Besucher"), $my3['c_value'])?>
			<?=printTableEnd()?>
			<?=printSubmit("Einstellungen speichern")?>
			</form>
			<h2>Aktuelle Eintr√§ge</h2>
<?

	db_query($db_data['module'],"DELETE FROM community_whoisonline WHERE UNIX_TIMESTAMP(changed) < (UNIX_TIMESTAMP(NOW()) - ".$my1['c_value'].")");
			
	$aDatabases = getCustomerTables();
			
	$res_wio = db_query("SELECT idUser,ip,tblUser,idPage,referrer,UNIX_TIMESTAMP(changed) as changed FROM community_whoisonline ORDER BY changed DESC");

?>
			<p><?=count_rows($res_wio)?> Besucher online</p>
			<table cellpadding="4" cellspacing="0" border="0" width="100%" class="table">
				<tr>
					<th style="width:auto;">Name</th>
					<th style="width: 100px;">Datenbank</th>
					<th style="width: 100px;">Gruppe</th>
					<th style="width: 200px;">Referrer</th>
					<th style="width: 100px;">IP</th>
					<th style="width: 100px;">Land</th>
					<th style="width: 100px;">Ort</th>
					<th style="width: 200px;">Seite</th>
					<th style="width: 120px;">Zeit</th>
				</tr>
<?
				while($my_wio = get_data($res_wio)) {
					
					$aTags = get_meta_tags('http://www.geobytes.com/IpLocator.htm?GetLocation&template=php3.txt&IpAddress='.$my_wio['ip']);
					
					$buffer = $buffer_entry;
					$my_user = array();
					if($my_wio['idUser']>0 && $my_wio['tblUser']>0) {
						$oCustomerDB = new Ext_CustomerDB_DB($my_wio['tblUser']);
						if($oCustomerDB) {
							$my_user = $oCustomerDB->getCustomer($my_wio['idUser']);
						}
					}
					if(empty($my_user)) {
						$my_user = array("nickname"=>"Gast");
					}
					$aGroups = preg_split("/\|/",$my_user['groups'],-1,PREG_SPLIT_NO_EMPTY);
					rsort($aGroups);
					$res = db_query("SELECT name FROM customer_groups WHERE id = '".$aGroups[0]."' LIMIT 1");
					$my = get_data($res);
					$sGroup = $my['name'];
			?>
				<tr>
					<td nowrap><?=$my_user['nickname']?>&nbsp;</td>
					<td nowrap><?=$aDatabases[$my_wio['tblUser']]?>&nbsp;</td>
					<td nowrap><?=$sGroup?>&nbsp;</td>
					<td nowrap><?=$my_wio['referrer']?>&nbsp;</td>
					<td nowrap><?=$my_wio['ip']?></td>
					<td nowrap><?=utf8_encode($aTags['country'])?></td>
					<td nowrap><?=utf8_encode($aTags['city'])?></td>
					<td nowrap><?=getPageTrack($my_wio['idPage'])?>&nbsp;</td>
					<td nowrap><?=strftime("%x %X",$my_wio['changed'])?>&nbsp;</td>
				</tr>
			<?
				}
			?>
			</table>
<? 
}
?>
		</td>
	</tr>
</table>
<?=Admin_Html::loadAdminFooter()?>