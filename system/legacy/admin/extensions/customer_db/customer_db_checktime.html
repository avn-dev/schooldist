<?php

///////////////////////////////////////////////////
////// Administration für Hauptmodul für die //////
////////// customer-login Funktionalität //////////
///////////////////////////////////////////////////

include(\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");
include(\Util::getDocumentRoot()."system/legacy/admin/extensions/customer_db/customer_db_class.inc.php");

echo Admin_Html::loadAdminHeader();

Access_Backend::checkAccess("modules_admin");

$my_parent = get_data(db_query($db_data['system'],"SELECT * FROM cms_content WHERE page_id = '".$_VARS['page_id']."' AND content LIKE '%<#content".(str_pad($_VARS['element_id'], 3, "0", STR_PAD_LEFT))."#>%'"));
$aParent = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

if($_POST['action'] == "config")
{
	$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);


    $config->email_message 	= $_VARS['email_message'];
	$config->email_subject 	= $_VARS['email_subject'];

    $config->email_delete_message 	= $_VARS['email_delete_message'];
	$config->email_delete_subject 	= $_VARS['email_delete_subject'];

	$config->period_1 	= $_VARS['period_1'];
	$config->period_2 	= $_VARS['period_2'];

	$config->idDatabase 	= $_VARS['idDatabase'];
	$config->StatusColumn 	= $_VARS['StatusColumn'];
	#$config->DateColumn 	= $_VARS['DateColumn'];

    $config->destination_table = $_VARS['destination_table'];


    $config->save_config($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id']);
}

// Laden der vorhandenen Daten
$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

#var_dump($_REQUEST);
#echo "<br />";
#var_dump($config);







//////////////////////////////////////////
//////////////////////////////////////////

function getColumns($idDatabase)
{
    $idDatabase=intval($idDatabase);


    if($idDatabase>0)
    {
        $query="SELECT * FROM `customer_db_definition` WHERE `db_nr` =$idDatabase ORDER BY name";
        $res=db_query($query);



        while($my=get_data($res))
        {
            $ret[$my['id']]=$my['name'];
        }

    }
    else
    {
        $ret[]="keine Datenbank ausgewählt";
    }

    return $ret;
}

//////////////////////////////////////////
//////////////////////////////////////////


$table_selection = "<select name=destination_table>";

$query="SELECT id,db_name FROM customer_db_config WHERE active=1";
$result=db_query($query);

while($my=get_data($result))
{
    #echo"<br />";
    #var_dump($my);

    if(intval($my['id'])==intval($config->destination_table))
    {
        $SELECTED="SELECTED";
    }
    else
    {
        $SELECTED='';
    }

    $table_selection.= "<option value=".$my['id']." $SELECTED>".$my['db_name']."</option>";
}


$table_selection.= "</select>";


?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
	<tr>
		<td valign="top">
			<h1>Konfiguration CheckTime-Modul</h1>

			<form name="customer_db_form" method=post enctype="multipart/form-data" action="<?=$_SERVER['PHP_SELF']?>">
			<input type="hidden" name="action" value="config">
			<input type="hidden" name="page_id" value="<?=$_VARS['page_id']?>">
			<input type="hidden" name="element_id" value="<?=$_VARS['element_id']?>">
			<input type="hidden" name="content_id" value="<?=$_VARS['content_id']?>">
			<?=printTableStart()?>

            <tr>
                <th colspan=2 align=left>
                    Erste Zeitspanne (Erinnerungsemail)
                </th>
            </tr>
                    <?=printFormText("Anzahl der Tage (Null zum deaktivieren)","period_1",$config->period_1)?>
    				<?=printFormText("Betreff der E-Mail","email_subject",$config->email_subject)?>
    				<?=printFormTextarea("Inhalt der E-Mail (Platzhalter: <#nickname#>, <#email#>, <#password#>; zusätzlich können alle weiteren Felder mit <#ext_NUMMER#> ausgegeben werden)","email_message",$config->email_message)?>

            <tr>
                <th colspan=2 align=left>
                    Zweite Zeitspanne (Verschieben des Users)
                </th>
            </tr>
                    <?=printFormText("Anzahl der Tage (Null zum deaktivieren)","period_2",$config->period_2)?>
    				<?=printFormText("Betreff der E-Mail","email_delete_subject",$config->email_delete_subject)?>
    				<?=printFormTextarea("Inhalt der E-Mail (Platzhalter: <#nickname#>, <#email#>, <#password#>; zusätzlich können alle weiteren Felder mit <#ext_NUMMER#> ausgegeben werden)","email_delete_message",$config->email_delete_message)?>
                    <th>Zieltabelle</th>
                    <td>
    				<?=$table_selection?>
                    </td>

            <tr>
                <th colspan=2 align=left>
                    Voreinstellungen (Bitte nicht ändern!)
                </th>
            </tr>

    		    <?=printFormSelect("Kundendatenbank","idDatabase",CustomerDb\Helper\Functions::getCustomerTables(),$config->idDatabase)?>
                <?=printFormSelect("Statusspalte","StatusColumn",getColumns($config->idDatabase),$config->StatusColumn)?>
                <?#=printFormSelect("Datumsspalte","DateColumn",getColumns($config->idDatabase),$config->DateColumn)?>


			<?=printTableEnd()?>
			<?=printSubmit("Konfiguration speichern")?>

		</form>
		</td>
	</tr>
</table>

<?=Admin_Html::loadAdminFooter()?>
