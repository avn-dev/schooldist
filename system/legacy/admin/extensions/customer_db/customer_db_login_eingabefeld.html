<?

include(\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Access_Backend::checkAccess("modules_admin");

/////////////////////////////////////////////////////
////// Moduladministration Login-Eingabefeld ////////
/////////////////////////////////////////////////////

// Dieses Script administriert das Eingabefeld Modul
// Hier kann man festlegen, zu welchem
// Datenbankfeld es gehört, wie es benannt werden soll,
// etc

///////////////////////////////////////////////

// Anzeigen, welche Felder es in der DB gibt
// Feld auswählen
// Vorgabewert setzen ( optional )
// Falls Textfeld o.�.:
// Größe / Zeilenanzahl setzen



require (\Util::getDocumentRoot()."system/legacy/admin/extensions/customer_db/customer_db_class.inc.php");

global $db_data;

$parent_element_id=0;
do
{
$parent_config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
$table_name = $parent_config->table_name;
$parent_element_id++;
}
While (!$table_name AND $parent_element_id<1000);



$identifier="customer_db_";
$definition_table=$identifier."definition";
$value_table=$identifier."values";
$SQL_handler = new customer_db;

// Initialisieren der Klasseninstanz
$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);


// Abspeichern der eingegebenen Daten
if ($form_action=="Speichern"  && $page_id > 0 && $element_id > 0)
{


  $config->field_name 		= $field_name;
  $config->default_value 	= $default_value;
  $config->height 			= $height;
  $config->width 			= $width;

  $config->save_config($page_id, $element_id);
}

// Laden der vorhandenen Daten
$config->config_class($page_id, $element_id);




////////////////////////////////////////////////

function show_tables($db_module,$SQL_handler,$identifier,$table_name)
{
  global $db_data;
  $SQL_handler->SQL_get_table_names($db_data['module'],$identifier);
  $result=$SQL_handler->result[1];
  echo "<select name=\"table_name\">";


  for ($i=0;$i<count($result);$i++)
  {
	if ($table_name==$result[$i])
	 {
	  $pre_select="SELECTED";
	 }
 	else
	 {
	   $pre_select="";
	 }
	echo "<option $pre_select >";
	echo $result[$i];
	echo "</option>";
  }

  echo"</select>";

  return $result;
} // ende function show_tables

////////////////////////////////////////////////

function show_fields($db_module,$SQL_handler,$definition_table, $table_name,$field_name,$identifier)
{
  if ($table_name=="")
  {
     $SQL_handler->SQL_get_table_names($db_module,$identifier);
	 $result=$SQL_handler->result[1];
	 $table_name=$result[0];
  }

  $option_name="db_nr";
  $position=strrpos($table_name,"_")+1;
  $option=substr($table_name,$position);

  $SQL_handler->SQL_get_row_by_option($db_module, $definition_table, $table_name, $option_name, $option);
  $result=$SQL_handler->result[1];

  //var_dump($result);

  for ($i=0;$i<count($result);$i++)
  {


    if ($result[$i]["field_nr"] == 1 OR $result[$i]["field_nr"] == 3)   // Begrenzung auf diese beiden Felder
	{
       $current_fields[]= $result[$i]["name"];
       $current_field_numbers[]= $result[$i]["field_nr"]; //"customer_login_".
    }



  }
  
  
  echo "<select name=\"field_name\">";
  for ($i=0;$i<count($current_fields);$i++)
  {

	if ($current_field_numbers[$i]==$field_name)
	 {
	  $pre_select="SELECTED";
	 }
 	else
	 {
	   $pre_select="";
	 }
	//$current_fields[$i]=htmlspecialchars($current_fields[$i]);
	echo "<option $pre_select value=\"".$current_field_numbers[$i]."\">";
	echo $current_fields[$i];
	echo "</option>";
  } // Ende for $i
  echo "</select>";
}




  function get_text_of_radio($db_module,$SQL_handler,$definition_table,$value_table,$table_name, $selected_field, $default_value)
  {
   // hole Optionen aus DB
   $SQL_handler->SQL_get_id($db_module,$definition_table,$table_name,$selected_field);

   $option_name="definition_id";
   $option=$SQL_handler->result[1];

   $SQL_handler->SQL_get_row_by_option($db_module, $value_table, $table_name, $option_name, $option);

   $result=$SQL_handler->result[1];

   for ($i=0;$i<count($result);$i++)
   {
     $current_display[$i]= $result[$i]["display"];
     $current_value[$i]= $result[$i]["value"];
   }


   // Eigentliche Anzeige:
   echo "<select name=\"default_value\">";
   for ($i=0;$i<count($current_display);$i++)
   {
     if ($default_value==$current_display[$i])
	  {
	   $pre_select="SELECTED";
	  }
 	 else
	  {
	   $pre_select="";
	  }
	 echo "<option $pre_select>".$current_display[$i]."</option>";
   } // Ende for $i
   echo "</select>";

  }



////////////////////////////////////////////////


$option=$config->field_name;
$option_name="field_nr";

$SQL_handler->SQL_get_row_by_option($db_data['module'], $definition_table, $table_name, $option_name,$option);
$result=$SQL_handler->result[1];
$field_type=$result["type"];


?>

<?=Admin_Html::loadAdminHeader()?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
<tr>
<td valign="top">
<h1>Konfiguration des Login-Eingabefeld</h1>


<form name="formular1" method=post enctype="multipart/form-data" action="<?=$PHP_SELF?>">

<input type='hidden' name="page_id" value=<?=$page_id?>>
<input type='hidden' name="element_id" value=<?=$element_id?>>
<input type='hidden' name="form_action" value="Speichern">


<table class=table border=0 cellpadding="4" cellspacing=0 >


    <tr class=first>
    <td>
        <table width='100%' align=center cellspacing="2" cellpadding="2" border="0" >
        <colgroup>
            <col valign=top align=left width=290>
            <col valign=top align=left>
        </colgroup>
        <tr>
            <th>Bitte zugehöriges Datenbank-Feld auswählen :</th>
            <td>
                <? show_fields($db_data['module'],$SQL_handler,$definition_table, $table_name,$config->field_name,$identifier);?>
            </td>
        </tr>
        <tr>
            <th>
                Welche Grösse soll das Feld haben?
            </th>
        </tr>
        <tr>
            <th>Bitte Breite eingeben (in Pixel) :</th>
            <td>
                <select name="width">
                <?
                for ($i=1;$i<301;$i++)
                {
                    echo "<option ";
                    if(!$config->width && $i==100)
                    {
                        echo "SELECTED";
                    }
                    else
                    {
                        if ($config->width==$i){echo "SELECTED";}
                    }

                    echo " >".$i."</option>";
                }
                ?>
                </select>
            </td>
        </tr>


        <tr class=first>
            <td align="center" colspan=2>
				<!--<input type=button value="speichern" OnClick="document.customer_db_data_form_back.submit()"></td> -->

                <input type=button value="Speichern" class="btn" OnClick='document.formular1.submit();'>&nbsp;&nbsp;&nbsp;
                <input class=btn type=button value="Fenster schliessen" OnClick='top.close();'>
            </td>
		</tr>
	   </table>
	</td>
    </tr>
</table>

</td>
</tr>
</table>

<?=Admin_Html::loadAdminFooter()?>