<?php

///////////////////////////////////////////////////
////// Administration für Hauptmodul für die //////
////////// customer-login Funktionalität //////////
///////////////////////////////////////////////////

include(\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");
include(\Util::getDocumentRoot()."system/legacy/admin/extensions/customer_db/customer_db_class.inc.php");

Access_Backend::checkAccess("modules_admin");

echo Admin_Html::loadAdminHeader();

$my_parent = get_data(db_query($db_data['system'],"SELECT * FROM cms_content WHERE page_id = '".$_VARS['page_id']."' AND content LIKE '%<#content".(str_pad($_VARS['element_id'], 3, "0", STR_PAD_LEFT))."#>%'"));
$aParent = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

if($_POST['action'] == "config") {
	$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
	
	$config->newentry 	= intval($_VARS['newentry']);
	$config->error_success 	= $_VARS['error_success'];
	$config->error_nosuccess 	= $_VARS['error_nosuccess'];
	$config->error_email 	= $_VARS['error_email'];
	$config->error_nickname 	= $_VARS['error_nickname'];
	$config->error_input	= $_VARS['error_input'];
	$config->sendconfirm 	= $_VARS['sendconfirm'];

    $config->saveaffiliate 	= $_VARS['saveaffiliate'];
	$config->backonerror 	= $_VARS['backonerror'];


    // Mail2User
	$config->email_subject 	= $_VARS['email_subject'];
	$config->email_message 	= $_VARS['email_message'];
    $config->email_link_destination = $_VARS['email_link_destination'];



    // Mail2Admin
	$config->sendinfo 	= $_VARS['sendinfo'];
	$config->alt_email 	= $_VARS['alt_email'];
	$config->admin_email_subject 	= $_VARS['admin_email_subject'];
	$config->admin_email_message 	= $_VARS['admin_email_message'];
	#$config->email_link_destination = $_VARS['admin_email_link_destination'];



	$config->save_config($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id']);
}

// Laden der vorhandenen Daten
$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
	<tr>
		<td valign="top">
			<h1>Konfiguration Speichern-Modul</h1>

			<form name="customer_db_form" method=post enctype="multipart/form-data" action="<?=$_SERVER['PHP_SELF']?>">
			<input type="hidden" name="action" value="config">
			<input type="hidden" name="page_id" value="<?=$_VARS['page_id']?>">
			<input type="hidden" name="element_id" value="<?=$_VARS['element_id']?>">
			<input type="hidden" name="content_id" value="<?=$_VARS['content_id']?>">
			<?=printTableStart()?>
				<?=printFormCheckbox("Als neuen Eintrag speichern? (Registrierung)","newentry", 1, $config->newentry)?>
				<?=printFormHTMLarea("Meldung: Speichern erfolgreich!","error_success",$config->error_success)?>
				<?=printFormHTMLarea("Fehlermeldung: Speichern nicht erfolgreich!","error_nosuccess",$config->error_nosuccess)?>
				<?=printFormHTMLarea("Fehlermeldung: Falsche Eingabe!","error_input",$config->error_input)?>
				<?=printFormCheckbox("Bei Fehler auf Eingabe zurück springen","backonerror",1,$config->backonerror)?>
				<?
				if($config->newentry)
                {
    				?>
    				<?=printFormSelect("Affiliate ID speichern in Feld","saveaffiliate",(array("0"=>"nicht speichern")+CustomerDb\Helper\Functions::getCustomerFields($aParent->idDatabase)),$config->saveaffiliate)?>
    				<?=printFormHTMLarea("Fehlermeldung: E-Mail-Adresse bereits vorhanden!","error_email",$config->error_email)?>
    				<?=printFormHTMLarea("Fehlermeldung: Nickname bereits vorhanden!","error_nickname",$config->error_nickname)?>
                    
                    
                    <th colspan=2>Mail an neuen User</th>
                    <?=printFormSelect("E-Mail senden?","sendconfirm", array("0"=>"keine","1"=>"einfache Bestätigung","2"=>"Registrierungs-Mail"), $config->sendconfirm)
                    #alt: printFormCheckbox("Bestätigungs-E-Mail senden?","sendconfirm", 1, $config->sendconfirm)?>
                    <?=printFormPageSelect("Zielseite, falls Registrierungs-Mail", "email_link_destination", $config->email_link_destination, "", "width:400px", 1); ?>
    				<?=printFormText("Betreff der Bestätigungs-E-Mail","email_subject",$config->email_subject)?>
    				<?=printFormTextarea("Inhalt der Bestätigungs-E-Mail (Platzhalter: <#nickname#>, <#email#>, <#password#>, <#link#>; zusätzlich können alle weiteren Felder mit <#ext_NUMMER#> ausgegeben werden)","email_message",$config->email_message)?>


                    <th colspan=2>Mail an Admin</th>
                    <?=printFormCheckbox("E-Mail an Admin senden?","sendinfo", 1, $config->sendinfo)?>
                    <?=printFormText("alternative E-Mail-Adresse","alt_email",$config->alt_email)?>
                    <?=printFormText("Betreff der E-Mail","admin_email_subject",$config->admin_email_subject)?>
    				<?=printFormTextarea("Inhalt der E-Mail (Platzhalter: <#nickname#>, <#email#>, <#activate_User#>, <#delete_User#>; zusätzlich können alle weiteren Felder mit <#ext_NUMMER#> ausgegeben werden)","admin_email_message",$config->admin_email_message)?>


    				<?
				}
				?>
			<?=printTableEnd()?>
			<?=printSubmit("Konfiguration speichern")?>

		</form>
		</td>
	</tr>
</table>

<?=Admin_Html::loadAdminFooter()?>

