<?
///////////////////////////////////////////////////
////// Administration für Hauptmodul für die //////
////////// customer-login Funktionalität //////////
///////////////////////////////////////////////////

include (\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Access_Backend::checkAccess("modules_admin");

LanguageLoadText(19);
require (\Util::getDocumentRoot().$LANGUAGE[1]);

//include (\Util::getDocumentRoot().$LANGUAGE[2]);
/*
require (\Util::getDocumentRoot().$LANGUAGE[6]);
include (\Util::getDocumentRoot().$LANGUAGE[3]);

include (\Util::getDocumentRoot().$LANGUAGE[4]);
include (\Util::getDocumentRoot().$LANGUAGE[5]);
*/


global $db_data;

//var_dump($_POST);


$SQL_handler = new customer_db;
$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);




$identifier=$LANGUAGE[6];
$definition_table=$identifier.$LANGUAGE[7];
$value_table=$identifier.$LANGUAGE[8];

////////////////////////////////////////////////
//echo"<br>";
//var_dump($config);

//echo "<br>$page_id page_id && $element_id element_id && form_action : $form_action";


if ($form_action=="Speichern"  && $page_id > 0 && $element_id > 0)
{
  //echo "Gespeichert!<br>";

  $config->table_name 	    = $table_name;
  //$config->url              = $url;
  //$config->success_msg      = $success_msg;
  //$config->fail_msg         = $fail_msg;

  $config->save_config($page_id, $element_id);

}

// Laden der vorhandenen Daten
$config->config_class($page_id, $element_id);

//echo"<br>";
//var_dump($config);
////////////////////////////////////////////////

function show_tables($db_module,$SQL_handler,$identifier,$table_name)
{
/*  $SQL_handler->SQL_get_table_names($db_module,$identifier);
  $result=$SQL_handler->result[1];
  echo "<select name=\"table_name\">";


  for ($i=0;$i<count($result);$i++)
  {
	if ($table_name==$result[$i])
	 {
	  $pre_select="SELECTED";
	 }
 	else
	 {
	   $pre_select="";
	 }
	echo "<option $pre_select >";
	echo $result[$i];
	echo "</option>";
  }

  echo"</select>";

  return $result;
*/
    $SQL_handler->SQL_get_table_names($db_module,$identifier);
    $result=$SQL_handler->result[1];
/*
    echo "intern tablenames : ";
    var_dump($result);
    echo "<br>";
*/
    $option_name = array();
    $option_name[]="db_nr";
    $option_name[]="field_nr";

    for ($i=0;$i<count($result);$i++)
    {
        $option = array();
        $pos=strrpos($result[$i],"_")+1;
        $option[]=substr($result[$i],$pos);
        $option[]=0;

        $SQL_handler->SQL_get_row_by_option($db_module,"customer_db_definition", $table_name, $option_name, $option);
        $name_result=$SQL_handler->result[1];
/*
        echo "<br>";
        echo "ext. tablenames : ";
        var_dump($name_result);
        echo "<br>options :";
        var_dump($option);
        echo "<br>";
*/
        $aDBNames[]=$name_result[0]["name"];
    }



//  $SQL_handler->SQL_get_table_names($db_module,$identifier);
//  $result=$SQL_handler->result[1];
  echo "<select name=\"table_name\">";


  for ($i=0;$i<count($result);$i++)
  {
	if ($table_name==$result[$i])
	 {
	  $pre_select="SELECTED";
	 }
 	else
	 {
	   $pre_select="";
	 }
	echo "<option $pre_select value=\"".$result[$i]."\">";
	echo $aDBNames[$i];
	echo "</option>";
  }

  echo"</select>";

  return $result;

} // ende function show_tables

////////////////////////////////////////////////


?>

<?=Admin_Html::loadAdminHeader();?>
<form name="customer_db_form" method=post enctype="multipart/form-data" action="<?=$PHP_SELF?>">

<input type='hidden' name="page_id" value=<?=$page_id?>>
<input type='hidden' name="element_id" value=<?=$element_id?>>
<input type='hidden' name="form_action" value="Speichern">



<table class=table border=0 cellpadding="4" cellspacing=0 >
<th>Konfiguration Eingabefeld-Hauptmodul</th>

<tr>
<td>
Bitte Datenbank auswählen :
</td>
</tr>
<tr>
<td>
 <? show_tables($db_data['module'],$SQL_handler,$identifier,$config->table_name);?>
</td>
<td>
</tr>

<?
/*
				<tr class=head><td>Wohin soll der Kunde nach dem Login gelangen?</td></tr>
				<tr class=first><td>
					<table width='100%' align=center cellspacing="2" cellpadding="2" border="0" >
                                                <colgroup>
                                                   <col width="20">
                                                   <col width="100">
                                                   <col width="10">
                                                   <col width="*">
                                                   <col width="20">
                                                </colgroup>
                                                <tr>
                                                   <td></td>
                                                   <td>Seite: </td>
                                                   <td></td>
                                                   <td><input type='text' class = 'input' style= 'width:400px' name = 'url' value='<?=$config->url? >'>
                                                      <a href="javascript:void(0)" onClick="window.open('/admin/ins_sitemap.html?sfunction=window.close&target=parent.opener.document.customer_db_login_form.url&slanguage=<?=$my_site['language']? >&structure=link','pref_sitemap','status=no,resizable=yes,menubar=no,scrollbars=yes,width=300,height=400');"> &nbsp&nbsp <img src="/admin/images/icon_sitemap.gif" alt="�ndern"></a></td>
                                                   <td></td>
						</tr>
					</table>
					</td>
				</tr>
				<tr class=head><td>Welche Meldungen soll der Kunde bekommen?</td></tr>
				<tr class=first><td>
					<table width='100%' align=center cellspacing="2" cellpadding="2" border="0" >
                                                <colgroup>
                                                   <col width="20">
                                                   <col width="100">
                                                   <col width="10">
                                                   <col width="*">
                                                   <col width="20">
                                                </colgroup>
                                                <tr>
                                                   <td></td>
                                                   <td>Bei Erfolg: </td>
                                                   <td></td>
                                                   <td><textarea name="success_msg" style= 'width:400px'><?=stripslashes($config->success_msg)? ></textarea></td>
                                                   <td></td>
						</tr>
                                                <tr>
                                                   <td></td>
                                                   <td>Bei Misserfolg: </td>
                                                   <td></td>
                                                   <td><textarea name="fail_msg" style= 'width:400px'><?=stripslashes($config->fail_msg)? ></textarea></td>
                                                   <td></td>
						</tr>
					</table>
					</td>
				</tr>
					</table>
					</td>
				</tr>




</table>

*/

?>
</table>
<input type=submit class=btn value="Speichern" OnCLick='document.customer_db_form.form_action.value="Speichern";document.customer_db_form.submit();'>
&nbsp;&nbsp;&nbsp;
<input type=button class=btn value="Fenster schliessen" OnClick='top.close();'>
</form>
<?


// speichern
//echo "<br><br><input type=submit name=\"action\" value=\"Speichern\"><br>";

?>
<?=Admin_Html::loadAdminFooter()?>