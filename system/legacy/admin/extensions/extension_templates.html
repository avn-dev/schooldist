<?php

require_once(Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");
include_once(\Util::getDocumentRoot()."system/includes/gui/gui.php");
include_once(\Util::getDocumentRoot()."system/includes/wdpdf/wdpdf.php");
include_once(\Util::getDocumentRoot()."system/extensions/customdata/customdata.php");

include_once(\Util::getDocumentRoot()."system/extensions/extension_templates/class.categories.php");
include_once(\Util::getDocumentRoot()."system/extensions/extension_templates/class.faq.php");

Access_Backend::checkAccess("modules_admin");


// Your MySQL Server Hostname
$strDbHost = "update.webdynamics.de";

// Your MySQL Server User Name
$strDbUser = "webdynamics";

// Your MySQL Sever Password
$strDbPasswd = "cms6598";

// Connect to MySql
$objWdDb = DB::createConnection('webdynamics', $strDbHost, $strDbUser, $strDbPasswd, 'webdynamics');

$strView = "";

// Ceck cases to identify what is to do
if (isset($_VARS['task']))
{ 
	switch ($_VARS['task']) {
		case 'newCat':
			// Create a new Category
			$strView = "newCat";
			break;
		case 'saveCat':
			// Save a Category
			$objCategory = new Ext_ExtensionTemplates_Categories((int)$_VARS['id'], $objWdDb);
			$objCategory->name = $_VARS['Category'];
			$objCategory->save();
			break;
		case 'editCat':
			// Edit a Category
			if (isset($_VARS['id']))
			{
				$objCategory = new Ext_ExtensionTemplates_Categories($_VARS['id'], $objWdDb);
			}		
			$strView = "edit";
			break;
		case 'deleteCat':
			// delete a Category
			if (isset($_VARS['id']))
			{
				$objCategory = new Ext_ExtensionTemplates_Categories($_VARS['id'], $objWdDb);
				$objCategory->delete();
			}		
			break;
		case 'getfaq':
			// Diplays the FAQs from a Category
			$strView = "getFAQCat";	
			break;
		case 'newFAQ':
			// Creats a new FAQ
			$strView = "newFAQ";
			break;
		case 'saveFAQ':
			// Save a FAQ
			$objFAQ = new Ext_ExtensionTemplates_FAQ((int)$_VARS['id'], $objWdDb);
			$objFAQ->frage = $_VARS['frage'];
			$objFAQ->antwort = $_VARS['antwort'];
			$objFAQ->idCategory = $_VARS['selectCat'];
			$objFAQ->save();
			break;	
		case 'editFAQ':
			// Edit a FAQ
			if (isset($_VARS['id']))
			{
				$objFAQ = new Ext_ExtensionTemplates_FAQ($_VARS['id'], $objWdDb);
			}	
			$strView = "editFAQ";	
			break;	
		case 'deleteFAQ':
			// Delete a FAQ
			$objFAQ = new Ext_ExtensionTemplates_FAQ($_VARS['id'], $objWdDb);
			$objFAQ->delete();	
			break;			
						
	}
}

// Read all Categories from the Database
$strSql = "SELECT * FROM `faq_categories` ORDER BY 'id' ASC";
$arrSql = array();
$arrCategories = $objWdDb->queryData($strSql);

// Prepare Categories for managing in the Forms
$arrCatList = array();
	foreach ($arrCategories as $arrCats) {
		$arrCatList[] = array('display' => $arrCats['name'], 'value' => $arrCats['id']);
	}	

// Create Page Object	
$objPage = new GUI_Page();

$objPage->appendElement(new GUI_Headline(array('text' => 'Erweiterungen » Vorlagen', 'type' => '1')));


// Create Form for build a new Category
if($strView == "newCat") {

	// Headline for Categories
	$objPage->appendElement(new GUI_Headline(array('text' => 'Kategorien erstellen', 'type' => '2')));
	
	// Build a form with Table for managing the Categories
	$objNewForm = new GUI_form(array('method' => 'POST', 'action'=>'extension_templates.html'));
	$objTable = new GUI_Table(array('cols' => array('Kategorie'))); 
	$objTable->appendRow(array('cols' => array(new GUI_FormText(array('name' => 'Category', 'value' => '', 'style' => 'width:400px;')))));
	$objNewForm->appendElement($objTable);
	
	// Transfers the id of the category in a hidden form tag
	$objNewForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'saveCat')));
	$objNewForm->appendElement(new GUI_FormSubmit(array('value' => 'Kategorie erstellen')));
	$objPage->appendElement($objNewForm);
}

// Create Form for editing a Category
if($strView == "edit") {
	
	// Headline
	$objPage->appendElement(new GUI_Headline(array('text' => 'Kategorien ändern', 'type' => '2')));
	
	// Creats a form for Editing a Category with table
	$objEditForm = new GUI_form(array('method' => 'POST', 'action'=>'extension_templates.html'));
	$objTable = new GUI_Table(array('cols' => array('Id','Kategorie'))); 
	$objTable->appendRow(array('cols' => array($objCategory->id, new GUI_FormText(array('name' => 'Category', 'value' => $objCategory->name, 'style' => 'width:400px;')))));
	$objEditForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'saveCat')));
	$objEditForm->appendElement(new GUI_FormHidden(array('name' => 'id', 'value' => $objCategory->id)));	
	$objEditForm->appendElement($objTable);
	$objEditForm->appendElement(new GUI_FormSubmit(array('value' => 'Kategorie speichern')));
	$objPage->appendElement($objEditForm);
	
} else {

	// Lists all Categories with buttons and displays the selcet box for the FAQs
	// fetch Images  
	$objImgDelete = new GUI_Image(array('url' => '/admin/media/delete.png'));
	$objImgEdit = new GUI_Image(array('url' => '/admin/media/edit.png'));
	
	// Create form for submiting a new Category
	$objNewForm = new GUI_Form(array('method' => 'POST', 'action' => 'extension_templates.html'));
	$objNewForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'newCat')));
	$objNewForm->appendElement(new GUI_FormSubmit(array('value' => 'Neue Kategorie erstellen')));
	
	// Create table-header
	$arrTableConfig = array('cols' => array('Id', 'Erweiterung', array('text'=>'Aktion', 'style' => 'width:50px;text-align:center;')));
	
	// Read table-content and set links for managing 
	$objTable=new GUI_Table($arrTableConfig);
	foreach ($arrCategories as $arrValue)
	{
		$objLinkEdit = new GUI_Link(array('url' => 'extension_templates.html?task=editCat&id='.$arrValue['id'], 'text' => $objImgEdit ));
		$objLinkDelete = new GUI_Link(array('url' => 'javascript:if(confirm(\'Kategorie wirklich löschen?\')) self.location.href=\'extension_templates.html?task=deleteCat&id='.$arrValue['id'].'\';', 'text' => $objImgDelete));
		$objImgList = new GUI_ElementList();
		$objImgList->appendElement($objLinkEdit);	
		$objImgList->appendElement($objLinkDelete);
		$objLinkCat = new GUI_Link(array('url' => 'extension_templates.html?task=getfaq&selectCat='.$arrValue['id'], 'text' => $arrValue['name']));
		$objTable->appendRow(array('cols' => array($arrValue['id'],$objLinkCat,$objImgList)));
		//$objTable->appendRow(array('cols' => array($arrValue['id'],$arrValue['name'],$objImgList)));
	}
	
	// Headline Cats
	$objPage->appendElement(new GUI_Headline(array('text' => 'Kategorien', 'type' => '2')));
	// Table Cats
	$objPage->appendElement($objTable);
	// From Cats
	$objPage->appendElement($objNewForm);

	// Headline FAQs
	$objPage->appendElement(new GUI_Headline(array('text' => 'FAQs', 'type' => '2')));
	// Form FAQs
	$objFAQForm = new GUI_Form(array('method' => 'POST', 'action' => 'extension_templates.html'));
	$objFAQForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'getfaq')));
	$objFAQForm->appendElement(new GUI_FormSelect(array('name' => 'selectCat', 'options' => $arrCatList)));
	$objFAQForm->appendElement(new GUI_FormSubmit(array('value' => 'Kategorie anzeigen')));
	
	// Create form for submiting a new Category
	$objNewFAQForm = new GUI_Form(array('method' => 'POST', 'action' => 'extension_templates.html'));
	$objNewFAQForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'newFAQ')));
	$objNewFAQForm->appendElement(new GUI_FormSubmit(array('value' => 'Neues FAQ erstellen')));
	
	// Insert Forms for FAQs
	$objPage->appendElement($objFAQForm);
	$objPage->appendElement($objNewFAQForm);
	
}


// Creats form for building a new FAQ
if ($strView == 'newFAQ') {

	// Headline
	$objPage->appendElement(new GUI_Headline(array('text' => 'FAQ erstellen', 'type' => '2')));
	
	// Form for new FAQ
	$objNewForm = new GUI_form(array('method' => 'POST', 'action'=>'extension_templates.html'));
	$objTable = new GUI_Table(array('cols' => array('Frage','Antwort','Kategorie'))); 
	$objTable->appendRow(array('cols' => array( 
		new GUI_FormText(array('name' => 'frage', 'value' => '', 'style' => 'width:300px;')),
		new GUI_FormTextarea(array('name' => 'antwort', 'value' => '', 'style' => 'width:500px;height:200px;')),
		new GUI_FormSelect(array('name' => 'selectCat', 'options' => $arrCatList)))));
	$objNewForm->appendElement($objTable);
	$objNewForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'saveFAQ')));
	$objNewForm->appendElement(new GUI_FormSubmit(array('value' => 'FAQ speichern')));
	$objPage->appendElement($objNewForm);
	
}

// Creats form for editing a FAQ
if ($strView == 'editFAQ') {
	
	// Headline
	$objPage->appendElement(new GUI_Headline(array('text' => 'FAQ erstellen', 'type' => '2')));
	
	// Inserts form for editing FAQs
	$objNewForm = new GUI_form(array('method' => 'POST', 'action'=>'extension_templates.html'));
	$objTable = new GUI_Table(array('cols' => array('Frage','Antwort','Kategorie'))); 
	$objTable->appendRow(array('cols' => array( 
		new GUI_FormText(array('name' => 'frage', 'value' => $objFAQ->frage, 'style' => 'width:300px;')),
		new GUI_FormTextarea(array('name' => 'antwort', 'value' => $objFAQ->antwort, 'style' => 'width:500px;height:200px;')),
		new GUI_FormSelect(array('name' => 'selectCat', 'options' => $arrCatList, 'selected' => $_VARS['selectCat'] )))));
			$objNewForm->appendElement($objTable);
			
	// Hidden Fields for submitting variables
	$objNewForm->appendElement(new GUI_FormHidden(array('name' => 'task', 'value' => 'saveFAQ')));
	$objNewForm->appendElement(new GUI_FormHidden(array('name' => 'id', 'value' => $_VARS['id'])));
	$objNewForm->appendElement(new GUI_FormSubmit(array('value' => 'FAQ speichern')));
	$objPage->appendElement($objNewForm);
	
}

// Lists all FAQs from a Category
if ($strView == "getFAQCat")
{
	// Query for getting FAQs data records from a specific Category 
	$strSql = "SELECT * FROM `faq_entries` WHERE `idCategory` = ".$_VARS['selectCat']." ORDER BY 'id' ASC";
	$arrSql = array();
	$arrEntries = $objWdDb->queryData($strSql);
	
	// Fetch Buttons
	$objImgDelete = new GUI_Image(array('url' => '/admin/media/delete.png'));
	$objImgEdit = new GUI_Image(array('url' => '/admin/media/edit.png'));
	
	
	// Create table-header
	$arrTableConfig = array('cols' => array('Id', 'Frage',  'Antwort', array('text'=>'Aktion', 'style' => 'width:50px;text-align:center;')));
			
	// Read table-content and set links for managing 
	$objTable=new GUI_Table($arrTableConfig);
	foreach ($arrEntries as $arrValue)
	{
		$objLinkEdit = new GUI_Link(array('url' => 'extension_templates.html?task=editFAQ&id='.$arrValue['id']."&selectCat=".$_VARS['selectCat'], 'text' => $objImgEdit ));
		$objLinkDelete = new GUI_Link(array('url' => 'javascript:if(confirm(\'FAQ wirklich löschen?\')) self.location.href=\'extension_templates.html?task=deleteFAQ&id='.$arrValue['id'].'\';', 'text' => $objImgDelete));
		$objImgList = new GUI_ElementList();
		$objImgList->appendElement($objLinkEdit);	
		$objImgList->appendElement($objLinkDelete);
		$objTable->appendRow(array('cols' => array($arrValue['id'],$arrValue['frage'],$arrValue['antwort'], $objImgList)));
	}

	// Get name of the actual Category		
	$strCatName ='';
	foreach ($arrCategories as $arrValueCats)
	 {
		
	 	if ($arrValueCats['id'] == $_VARS['selectCat']) {
	 		$strCatName = $arrValueCats['name'];
	 	}	 	 
	 }
	
	$objPage->appendElement(new GUI_Headline(array('text' => 'FAQs anzeigen - Kategorie: '.$strCatName, 'type' => '2')));
	$objPage->appendElement($objTable);
		
}

echo $objPage->generateHTML();
