<?php

// Includes
include "../includes/main.inc.php";

include "../../system/includes/sajax.inc.php";

// Rechte pruefen
Access_Backend::checkAccess("modules_admin");

set_time_limit(1200);
ignore_user_abort(true);

// Uebergabewerte auslesen
$iID = intval($_VARS["id"]);
$sTodo = trim($_VARS["form_action"]);

// Konstante
$sMedia = "/media/system/gallery/";
$sMediaPath = $_SERVER["DOCUMENT_ROOT"] . $sMedia;

// Funktionen
function fReadItemsChange($iListID, $iTimeLast, $saIDsListe, $saIDsTrash)
{
	$oReturn = null;

	// aktuelle DB-Zeit ermitteln
	$sSQL = "SELECT UNIX_TIMESTAMP(NOW()) AS n";
	$rRes = db_query($sSQL);
	$aMy = get_data($rRes);
	$iNow = $aMy["n"];

	// Ermitelle alle in der Zeit nach iTimeLast veraenderten Items
	$sSQL = "
		SELECT
			i.`id` AS item_id,
			i.`name`,
			i.`active`,
			f.`path`,
			f.`filename`
		FROM
			`gallery2_items` AS i,
			`gallery2_files` AS f
		WHERE
			i.`list_id`='" . intval($iListID) . "'
			AND i.`id`=f.`item_id`
			AND f.`size_id`='1'
			AND (UNIX_TIMESTAMP(i.`changed`) >= '" . intval($iTimeLast) . "')
		ORDER BY i.`position`
	";
	$rRes = db_query($sSQL);
	$aImages = array(1 => array(), 2 => array());
	while($aMy = get_data($rRes))
	{
		$iActive = intval($aMy["active"]);
		if(1 != $iActive && 2 != $iActive)
		{
			$iActive = 3;
		}
		// NICE: Anzahl der Informationen hier oder beim SQL reduzieren
		$aImages[$iActive][] = $aMy;
	}

	// Konvertierung der Items, die mometan angezeigt werden
	$aListe[1] = explode(',', $saIDsListe);
	$aListe[2] = explode(',', $saIDsTrash);

	// Alle neu in die Listen hinzuzufuegenden und entgueltig entfernten Items merken
	$aNeu = array(1 => array(), 2 => array());
	$aWeg = array(1 => array(), 2 => array());
	$aiNeuAnz = array(1 => 0, 2 => 0);
	$aiWegAnz = array(1 => 0, 2 => 0);
	for($i = 1; $i < 4; $i++)
	{
		if(count($aImages[$i]))
		{
			foreach($aImages[$i] as $aImage)
			{
				// "endgueltig Geloeschte" entfernen
				if(3 == $i)
				{
					if(in_array($aImage["item_id"], $aListe[1]))
					{
						$aWeg[1][] = $aImage;
						$aiWegAnz[1]++;
					}
					else if(in_array($aImage["item_id"], $aListe[2]))
					{
						$aWeg[2][] = $aImage;
						$aiWegAnz[2]++;
					}
				}
				// Neue bzw Verschobene
				else
				{
					if(!in_array($aImage["item_id"], $aListe[$i]))
					{
						$aNeu[$i][] = $aImage;
						$aiNeuAnz[$i]++;
					}
					$iInvers = intval(2 / $i);
					if(in_array($aImage["item_id"], $aListe[$iInvers]))
					{
						$aWeg[$iInvers][] = $aImage;
						$aiWegAnz[$iInvers]++;
					}
				}
			}
		}
	}

	// Variable mit Resultaten fuellen und zurueckgeben
	$oReturn->iTimeLast = $iNow;
	$oReturn->iListID = intval($iListID);
	$oReturn->aNeu = $aNeu;
	$oReturn->aWeg = $aWeg;
	$oReturn->iNeuAnz = $aiNeuAnz;
	$oReturn->iWegAnz = $aiWegAnz;

	return $oReturn;
}


// sajax: Initialisierung
sajax_init();
$sajax_debug_mode = 0;
sajax_export("fReadItemsChange");
sajax_handle_client_request();

echo Admin_Html::loadAdminHeader();

?>
	<script type="text/javascript">
		<!--
			function showRow(id, on)
			{
				var oPopupTr = document.getElementById('tr_' + id);
				if(1 == on)
				{
					oPopupTr.style.backgroundColor = '#d4ddf0';
				}
				else
				{
					oPopupTr.style.backgroundColor = '';
				}
			}
		//-->
	</script>
	<style type="text/css">
		ul.sortablelist
		{
			background: #f5f5f5;
			border: 1px solid grey;
			margin-top: 0px;
			padding-top: 0px;
			min-height: 74px;
		}

		ul.sortablelist li
		{
			padding:2px;
			margin:3px;
			list-style-image:none;
			list-style-type:none;
		}

		li.user_a
	    {
			border:1px solid #E8A400;
			background-color: #FFF4D8;
			cursor: move;
		}

		li.user_b
		{
			background-color: #ECF3E1;
			border:1px solid #C5DEA1;
			cursor: move;
		}
	</style>

	<script type="text/javascript">
	<!--
<?php

sajax_show_javascript();

?>

		function cDataObject()
		{
			this.iTimeLast = 0;
			this.iAnz = new Array();
			this.aiIDs = new Array();
			for(j = 1; j < 3; j++)
			{
				this.iAnz[j] = 0;
				this.aiIDs[j] = new Array();
			}
		}
		var oNewData = new cDataObject;


		function getDataChanges(iListID)
		{
			if(oNewData.iTimeLast > 0)
			{
				x_fReadItemsChange(iListID, oNewData.iTimeLast, oNewData.aiIDs[1], oNewData.aiIDs[2], changeItems);
			}
			else
			{
				x_fReadItemsChange(iListID, 0, 0, 0, changeItems);
			}
		}


		function changeItems(oReturn)
		{
			oListe = document.getElementById('destlist1');
			oTrash = document.getElementById('trash');

			oNewData.iTimeLast = oReturn.iTimeLast;

			iListID = oReturn.iListID;
			iInsgesamtGeaendert = 0;
			// erst die Gewuenschten loeschen
			for(j = 1; j < 3; j++)
			{
				for(i = 0; i < oReturn.iWegAnz[j]; i++)
				{
					oWeg = oReturn.aWeg[j][i];
					for(h = 1; h <= oNewData.iAnz[j]; h++)
					{
						if(oNewData.aiIDs[j][h] == oWeg.item_id)
						{
							oNewData.aiIDs[j][h] = 0;
							oNewData.iAnz[j]--;
						}
					}
					oKnoten = document.getElementById('u_' + oWeg.item_id);
					if(1 == j)
					{
						oListe.removeChild(oKnoten);
					}
					else
					{
						oTrash.removeChild(oKnoten);
					}
				}
			}
			// dann die Neuen hinzufuegen
			for(j = 1; j < 3; j++)
			{
				for(i = 0; i < oReturn.iNeuAnz[j]; i++)
				{
					oNeu = oReturn.aNeu[j][i];
					sImageSrc = oNeu.path + oNeu.filename + "?" + parseInt(Math.random() * 100000);
					newLi = document.createElement("li");
					newImg = document.createElement("img");
					newImg.style.verticalAlign = 'middle';
					newImg.alt = "";
					newImg.src = sImageSrc;
					newLi.appendChild(newImg);
					oLeerzeichen = document.createElement("span");
					oLeerzeichen.innerHTML = "&nbsp;";
					newLi.appendChild(oLeerzeichen);
					newSpan = document.createElement("span");
					newSpan.id = "u_text_" + oNeu.item_id;
					newSpan.innerHTML = oNeu.name;
					newLi.appendChild(newSpan);
					oLeerzeichen2 = document.createElement("span");
					oLeerzeichen2.innerHTML = "&nbsp;";
					newLi.appendChild(oLeerzeichen2);
					newA = document.createElement("a");
					newText = document.createTextNode("(edit)");
					newA.appendChild(newText);
					newA.href = "javascript:editText(" + oNeu.item_id + ");";
					newLi.appendChild(newA);
					newLi.className = "user_a";
					newLi.id = "u_" + oNeu.item_id;
					oNewData.iAnz[j]++;
					oNewData.aiIDs[j][oNewData.iAnz[j]] = oNeu.item_id;
					if(1 == j)
					{
						oListe.appendChild(newLi);
					}
					else
					{
						oTrash.appendChild(newLi);
					}
					newInput = document.createElement('input');
					newInput.setAttribute('type', 'hidden');
					newInput.setAttribute('name', "u_name_" + oNeu.item_id);
					newInput.setAttribute('id', "u_name_" + oNeu.item_id);
					newInput.setAttribute('value', oNeu.name);
					document.getElementById('formular').appendChild(newInput);
					iInsgesamtGeaendert++;
				}
			}

			if(0 < iInsgesamtGeaendert)
			{
				// <![CDATA[
					Sortable.create("destlist1", {
						dropOnEmpty:true, containment:["destlist1", "trash"], ghosting:false,
						constraint:false, onUpdate:function(element){listChanged(element, 'destlist1')}
					});
					Sortable.create("trash", {
						dropOnEmpty:true, containment:["destlist1", "trash"], ghosting:false,
						constraint:false, onUpdate:function(element){listChanged(element, 'trash')}
					});
				// ]]>
			}

			var rTimeOut = window.setTimeout("getDataChanges(iListID)", 5000);
		}


		function editText(iItemID)
		{
			oSpan = document.getElementById("u_text_" + iItemID);
			alterText = oSpan.innerHTML;
			neuerText = prompt("Bildname: ", alterText);
			if(null != neuerText)
			{
				oSpan.innerHTML = neuerText;
				document.getElementById("u_name_" + iItemID).value = neuerText;
			}
		}
		
		function saveDefaultName(sName) {

			var strRequestUrl = '/admin/extensions/gallery2.ajax.php';
			var strParameters = 'task=save_default_name&name='+encodeURIComponent(sName);

			var objAjax = new Ajax.Request(
									strRequestUrl,
									{
										method : 'post',
										parameters : strParameters
									});
			
		}
		
	//-->
	</script>
	<table cellpadding="0" cellspacing="30" border="0" style="width:100%;height:100%;">
		<tr>
			<td valign="top">
				<h1>Bildergalerie-Administration</h1>
<?php






// Error-Text initialisieren
$sError = "";












// Wenn die Einstellungen editiert werden sollen, ...
if("settings" == $sTodo || "saveSettings" == $sTodo || "delSettings" == $sTodo)
{
	echo "				<h2>Bildergalerie - Einstellungen</h2>\n";

	// wurde "speichern"-Button betaetitgt, ...
	if("saveSettings" == $sTodo)
	{
		$aMax = array();
		if(is_array($_REQUEST) && count($_REQUEST))
		{
			$aRows = array();
			// sichere alle Max-Werte in $aMax
			foreach($_REQUEST as $sKey => $sValue)
			{
				if("sizeId_" == substr($sKey, 0, 7))
				{
					$iSizeId = intval(substr($sKey, 7));
					if($iSizeId)
					{
						$aRows[] = $iSizeId;
					}
				}
			}
			$aSizes = array();
			$aBrandings = array();
			if(count($aRows))
			{
				foreach($aRows as $iKey => $iRow)
				{
					$aSizes[$iRow]["id"] = intval($_REQUEST["sizeId_" . $iRow]);
					$aSizes[$iRow]["height"] = intval($_REQUEST["iMaxHeight_" . $iRow]);
					$aSizes[$iRow]["width"] = intval($_REQUEST["iMaxWidth_" . $iRow]);

					$aBrandings[$iRow]["id"] = intval($_REQUEST["brandId_" . $iRow]);
					$sFilename = trim($_REQUEST["branding_" . $iRow]);
					$aBrandings[$iRow]["file"] = basename($sFilename);
					$aBrandings[$iRow]["path"] = substr($sFilename, 0, strlen($Filename) - strlen($aBrandings[$iRow]["file"]));
					$aBrandings[$iRow]["brandX"] = intval($_REQUEST["brandX_" . $iRow]);
					$aBrandings[$iRow]["brandY"] = intval($_REQUEST["brandY_" . $iRow]);
					$aBrandings[$iRow]["corner"] = $_REQUEST["corner_" . $iRow];
					$aBrandings[$iRow]["size_id"] = $aSizes[$iRow]["id"];
				}
			}

			// speichere nun alle Einstellungen in der DB (Sizes)
			if(count($aSizes))
			{
				foreach($aSizes as $iRow => $aRow)
				{
					if($aRow["width"] && $aRow["height"])
					{
						$sSQL = "
							INSERT INTO `gallery2_sizes`
								(`max_width`,
								`max_height`,
								`active`)
							VALUES
								('" . intval($aRow["width"]) . "',
								'" . intval($aRow["height"]) . "',
								'1')
						";
 						db_query($sSQL);
						$aRow["id"] = get_insert_id();
						$aBrandings[$iRow]["size_id"] = $aRow["id"];
					}
				}
			}

			// speichere nun alle Einstellungen in der DB (Brandings)
			if(count($aBrandings))
			{
				foreach($aBrandings as $iRow => $aRow)
				{
					if(intval($aRow["size_id"]))
					{
						$iRowID = intval($aRow["id"]);
						$sSQL = ($iRowID?"UPDATE":"INSERT") . " `gallery2_brandings`
							SET
								`path`='" . addslashes($aRow["path"]) . "',
								`filename`='" . addslashes($aRow["file"]) . "',
								`x`='" . intval($aRow["brandX"]) . "',
								`y`='" . intval($aRow["brandY"]) . "',
								`corner`='" . addslashes($aRow["corner"]) . "',
								`size_id`='" . intval($aRow["size_id"]) . "',
								`type`='image'" .
							($iRowID?" WHERE `id`='" . intval($iRowID) . "'":"");
 						db_query($sSQL);
					}
				}
			}
		}
	}  // ("saveSettings" == $sTodo) Ende




	if("delSettings" == $sTodo)
	{
		$iSizeId = intval($_REQUEST["size_id"]);
		$sSQL = "
			UPDATE `gallery2_sizes`
			SET `active`='2'
			WHERE `id`='" . intval($iSizeId) . "'
		";
		db_query($sSQL);
	}




	// lies alle Werte aus der DB aus
	$sSQL = "
		SELECT
			*,
			b.`id` AS brand_id,
			s.`id` AS `sizes_id`
		FROM `gallery2_sizes` AS s
		LEFT JOIN `gallery2_brandings` AS b
			ON b.`size_id`=s.`id`
		WHERE s.`active`='1'
		ORDER BY s.`id`";
	$rRes = db_query($sSQL);
	$aSizes = array();
	while($aMy = get_data($rRes))
	{
		$aSizes[intval($aMy["sizes_id"])] = $aMy;
	}
?>
	<script type="text/javascript">
		function addConvertSizeInput()
		{
			var iNextSizeId = parseInt(document.getElementById('nextSizeId').value) + 1;
			var oNewTr1 = document.createElement("tr");
			var oNewTh11 = document.createElement("th");
			oNewTh11.innerHTML = "Bildkonvertierung " + iNextSizeId + ":";
			oNewTr1.appendChild(oNewTh11);
			var oNewTd21 = document.createElement("td");
			oNewTd21.align = "center";
			oNewTd21.innerHTML = "<input type=\"txt\" name=\"iMaxWidth_" + iNextSizeId + "\" size=\"5\" maxlength=\"5\" value=\"0\" class=\"txt\" />" +
				"<input type=\"hidden\" name=\"sizeId_" + iNextSizeId + "\" value=\"0\" />";
			oNewTr1.appendChild(oNewTd21);
			var oNewTd31 = document.createElement("td");
			oNewTd31.align = "center";
			oNewTd31.innerHTML = "<input type=\"txt\" name=\"iMaxHeight_" + iNextSizeId + "\" size=\"5\" maxlength=\"5\" value=\"0\" class=\"txt\" />";
			oNewTr1.appendChild(oNewTd31);
			var oNewTd41 = document.createElement("td");
			oNewTd41.align = "center";
			oNewTd41.innerHTML = "&nbsp;";
			oNewTr1.appendChild(oNewTd41);
			oNewTr1.style.height = "20px";
			document.getElementById('tbodyViews').appendChild(oNewTr1);

			var oNewTr2 = document.createElement("tr");
			var oNewTh12 = document.createElement("th");
			oNewTh12.innerHTML = "Wasserzeichen Datei:";
			oNewTr2.appendChild(oNewTh12);
			var oNewTd22 = document.createElement("td");
			oNewTd22.align = "left";
			oNewTd22.colSpan = 3;
			oNewTd22.innerHTML = "<input type=\"text\" name=\"branding_" + iNextSizeId + "\" class=\"txt\" site=\"60\" class=\"form_elem\" readonly style=\"background-color:#dededf;\">" +
				"&nbsp;<button class=\"btn\" type=\"button\" onClick=\"window.open('/admin/frame.html?file=media&mode=selecticon&form_name='+this.form.name+'&input_name=&submit_button_value=<?=urlencode("übernehmen")?>&form_submit=0&input_name_title=&input_name_name=branding_" + iNextSizeId + "', 'media','status=no,resizable=yes,menubar=no,scrollbars=yes,width=770,height=550');\">ausw&auml;hlen</button>" +
				"&nbsp;<button class=\"btn\" type=\"button\" onClick=\"this.form.elements['branding_" + iNextSizeId + "'].value='';\">entfernen</button>";
			oNewTr2.appendChild(oNewTd22);
			oNewTr2.style.height = "20px";
			document.getElementById('tbodyViews').appendChild(oNewTr2);

			var oNewTr3 = document.createElement("tr");
			var oNewTh13 = document.createElement("th");
			oNewTh13.innerHTML = "Wasserzeichen Startpunkt:";
			oNewTr3.appendChild(oNewTh13);
			var oNewTd23 = document.createElement("td");
			oNewTd23.align = "center";
			oNewTd23.innerHTML = "<input name=\"brandX\" class=\"txt\" type=\"text\">";
			oNewTr3.appendChild(oNewTd23);
			var oNewTd33 = document.createElement("td");
			oNewTd33.align = "center";
			oNewTd33.innerHTML = "<input name=\"brandY\" class=\"txt\" type=\"text\">";
			oNewTr3.appendChild(oNewTd33);
			var oNewTd43 = document.createElement("td");
			oNewTd43.align = "center";
			oNewTd43.innerHTML = "von <select name=\"corner\">" +
				"<option value=\"oben_links\">oben links</option>" +
				"<option value=\"oben_rechts\">oben rechts</option>" +
				"<option value=\"unten_links\">unten links</option>" +
				"<option value=\"unten_rechts\">unten rechts</option>" +
				"</select>";
			oNewTr3.appendChild(oNewTd43);
			oNewTr3.style.height = "20px";
			document.getElementById('tbodyViews').appendChild(oNewTr3);

			var oNewTr5 = document.createElement("tr");
			var oNewTd5 = document.createElement("td");
			oNewTd5.colSpan = 4;
			oNewTd5.style.height = "20px";
			oNewTd5.innerHTML = "&nbsp;";
			oNewTr5.appendChild(oNewTd5);
			document.getElementById('tbodyViews').appendChild(oNewTr5);

			document.getElementById('nextSizeId').value = iNextSizeId;
		}


		function delConverts(size_id)
		{
			bCheck = confirm(unescape("Wollen Sie diese Konvertierung wirklich l%F6schen%3F"));
			if(bCheck)
			{
				document.getElementById('form_action').value = "delSettings";
				document.getElementById('size_id').value = size_id;
				document.formular.submit();
			}
		}
		
		
		
	</script>
	<form name="formular" method="POST" action="<?=$_SERVER["PHP_SELF"] . "?" . rand(0, 100000);?>" enctype="multipart/form-data">
		<input type="hidden" name="form_action" value="saveSettings">
		<input type="hidden" name="size_id" value="">
		<table cellpadding="4" cellspacing="0" border="0" width="100%" class="table">
			<tbody id="tbodyViews">
<?php
	$i = 0;
	if(is_array($aSizes) && count($aSizes))
	{
		foreach($aSizes as $aSize)
		{
			$i++;
			$iSizeId = intval($aSize["sizes_id"]);
			$iMaxWidth = intval($aSize["max_width"]);
			$iMaxHeight = intval($aSize["max_height"]);
			$iBrandId = intval($aSize["brand_id"]);
			$sFile = htmlspecialchars($aSize["filename"]);
			$aSelected[$aSize["corner"]] = " selected";
?>
				<tr style="height:20px">
					<th width="25%">
						Bildkonvertierung <?=$i;?> (ID #<?=$iSizeId;?>):
						<input type="hidden" name="sizeId_<?=$i;?>" value="<?=$iSizeId;?>" />
						<input type="hidden" name="brandId_<?=$i;?>" value="<?=$iBrandId;?>" />
					</th>
					<td align="center" width="25%"><?=$iMaxWidth;?>&nbsp;</td>
					<td align="center" width="25%"><?=$iMaxHeight;?>&nbsp;</td>
					<td align="center" width="25%">
						<button type="button" onClick="delConverts(<?=$iSizeId;?>)" class="btn">
							Konvertierung l&ouml;schen
						</button>
					</td>
				</tr>
				<tr>
					<th>Wasserzeichen Datei:</th>
					<td colspan="3">
						<input type="text" name="branding_<?=$i;?>" class="txt" value="<?=$sFile;?>" site="60" class="form_elem" readonly style="background-color:#dededf;">
						&nbsp;
						<button class="btn" type="button" onClick="window.open('/admin/frame.html?file=media&mode=selecticon&form_name='+this.form.name+'&input_name=&submit_button_value=<?=urlencode("übernehmen")?>&form_submit=0&input_name_title=&input_name_name=branding_<?=$i;?>', 'media','status=no,resizable=yes,menubar=no,scrollbars=yes,width=770,height=550');">ausw&auml;hlen</button>
						&nbsp;
						<button class="btn" type="button" onClick="this.form.elements['branding_<?=$i;?>'].value='';">entfernen</button>
					</td>
				</tr>
				<tr>
					<th>Wasserzeichen Startpunkt:</th>
					<td align="center"><input name="brandX_<?=$i;?>" class="txt" type="text" value="<?=intval($aSize["x"]);?>"></td>
					<td align="center"><input name="brandY_<?=$i;?>" class="txt" type="text" value="<?=intval($aSize["y"]);?>"></td>
					<td align="center">von
						<select name="corner_<?=$i;?>">
							<option value="oben_links"<?=$aSelected["oben_links"];?>>oben links</option>
							<option value="oben_rechts"<?=$aSelected["oben_rechts"];?>>oben rechts</option>
							<option value="unten_links"<?=$aSelected["unten_links"];?>>unten links</option>
							<option value="unten_rechts"<?=$aSelected["unten_rechts"];?>>unten rechts</option>
						</select>
					</td>
				</tr>
				<tr style="height:20px">
					<td colspan="4">&nbsp;</td>
				</tr>
<?php
		}
	}
	else
	{
?>
				<tr><td colspan="4"></td></tr>
<?
	}
	$iLastId = $i;
?>
			</tbody>
		</table>

		<p align="right">
			<input type="hidden" id="nextSizeId" name="nextSizeId" value="<?=$iLastId;?>" />
			<button type="button" onClick="window.location.href='<?=$_SERVER["PHP_SELF"] . "?" . rand(0, 100000)?>'" class="btn">zur&uuml;ck</button>&nbsp; 
			<button type="button" onClick="addConvertSizeInput();" class="btn">Bildkonvertierung hinzuf&uuml;gen</button>&nbsp;
			<button type="submit" class="btn">speichern</button>&nbsp;
		</p>

	</form>
<?php
}












// oder eine Galerie editiert werden soll, ...
else if("edit" == $sTodo || "saveList" == $sTodo)
{
	// wenn Galeriedaten gespeichert werden sollen, ...
	if("saveList" == $sTodo)
	{
		// lies aktuellen Galerienamen aus der DB aus, um gleich die Verzeichnisse in der DB anzupassen
		$sSQL = "
			SELECT `name` FROM `gallery2_list`
			WHERE `id`='" . intval($iID) . "' AND `active`='1'";
		$rRes = db_query($sSQL);
		$aMy = get_data($rRes);
		$sGalleryName = $aMy["name"];

		// fuege bzw. ueberschreibe ihn und die Beschreibung in der DB (ein)
		$sDateNeu = strtotimestamp(trim($_VARS["gallery_date"]), 1);
		$sNameNeu = trim($_VARS["gallery_name"]);
		$sDescription = trim($_VARS["gallery_description"]);
		$sSQL = ($iID?"UPDATE ":"INSERT INTO ") . "`gallery2_list`
			SET
				`name` = '" . \DB::escapeQueryString($sNameNeu) . "',
				`description` = '" . \DB::escapeQueryString($sDescription) . "',
		";
		if($iID) {
			$sSQL.=" `created`= NOW(),";
		}
		$sSQL .= " `date` = ".$sDateNeu;
		if($iID)
		{
			$sSQL .= " WHERE id='" . intval($iID) . "' AND `active`='1'";
		}
		else
		{
			$sSQL .= ", `active`='1'";
		}

		DB::executeQuery($sSQL);

		// nur wenn Galerie vorher bereits vorhanden war
		if($iID)
		{
			// Verzeichnis im Filesystem ggf umbenennen
			$sCleanGalleryName = \Util::getCleanFileName($sGalleryName);
			$sCleanNameNeu = \Util::getCleanFileName($sNameNeu);
			$sOldPathname = $sMediaPath . $sCleanGalleryName . "_" . $iID;
			$sNewPathname = $sMediaPath . $sCleanNameNeu . "_" . $iID;
			$bNewPath = strcmp($sCleanGalleryName, $sCleanNameNeu);
			if($bNewPath)
			{
				if(file_exists($sOldPathname))
				{
					rename($sOldPathname, $sNewPathname);
				}

				$sSQL = "
					SELECT
						g2f.`id` AS file_id,
						g2f.`path`
					FROM
						`gallery2_files` AS g2f,
						`gallery2_items` AS g2i
					WHERE
						g2f.`item_id`=g2i.`id`
						AND g2i.`list_id`='" . intval($iID) . "'
				";
				$rRes = db_query($sSQL);
				$aFiles = array();
				while($aMy = get_data($rRes))
				{
					$aFiles[] = $aMy;
				}
				if(count($aFiles))
				{
					foreach($aFiles as $aFile)
					{
						$sOldPath = substr($aFile["path"], strlen($sMedia));
						$aOldPath = explode("/", $sOldPath);
						$sNewPath = $sMedia . $sCleanNameNeu . "_" . $iID . "/";
						if(count($aOldPath))
						{
							$bFirst = true;
							foreach($aOldPath as $aPath)
							{
								if($bFirst)
								{
									$bFirst = false;
								}
								else
								{
									$sNewPath .= $aPath . ($aPath?"/":"");
								}
							}
						}

						$sSQL = "
							UPDATE `gallery2_files`
							SET `path`='" . addslashes($sNewPath) . "'
							WHERE `id`='" . intval($aFile["file_id"]) . "'
						";
						db_query($sSQL);
					}
				}
			}

			// alle Positionen erneuern bzw als geloescht markieren
			$asListPositions = explode('|', $_REQUEST["h_list"]);
			if(count($asListPositions))
			{
				foreach($asListPositions as $sListPositions)
				{
					$aiListPositions[] = intval(substr($sListPositions, 2));
				}
				$i = 1;
				foreach($aiListPositions as $iListPosition)
				{
					if($iListPosition)
					{
						$sNewName = $_REQUEST["u_name_" . intval($iListPosition)];

						$sSQL = "UPDATE `gallery2_items`
							SET
								`position`='" . intval($i) . "',
								`active`='1',
								`changed_by`='" . intval($user_data["id"]) . "',
								`name`='" . addslashes($sNewName) . "'
							WHERE
								`id`='" . intval($iListPosition) . "'
								AND `list_id`='" . intval($iID) . "'";
						db_query($sSQL);
						$i++;
					}
				}
			}
			$asTrashIds = explode('|', $_REQUEST["h_trash"]);
			if(count($asTrashIds))
			{
				foreach($asTrashIds as $sTrashId)
				{
					$aiTrashIds[] = intval(substr($sTrashId, 2));
				}
				$i = 1;
				foreach($aiTrashIds as $iTrashId)
				{
					if($iTrashId)
					{
						
						$sSql = "SELECT f.* FROM gallery2_items i, gallery2_files f WHERE i.id = f.item_id AND i.id = :iId AND i.list_id = :iListId";
						$aSql = array('iId'=>$iTrashId, 'iListId'=>$iID);
						$aData = DB::getPreparedQueryData($sSql, $aSql);
						foreach((array)$aData as $aItem) {
							unlink(\Util::getDocumentRoot().$aItem['path'].$aItem['filename']);
						}

						$sNewName = $_REQUEST["u_name_" . intval($iTrashId)];

						$sSQL = "
							DELETE FROM gallery2_items, gallery2_files USING gallery2_items INNER JOIN gallery2_files 
							WHERE gallery2_items.id = gallery2_files.item_id AND
								gallery2_items.id = " . intval($iTrashId) . "
								AND gallery2_items.list_id = " . intval($iID) . "
						";
						db_query($sSQL);
						$i++;

					}
				}
			}
		}
		else
		{
			$iID = intval(get_insert_id());
			$query="
				UPDATE `eventmodul_events`
				SET
					`gallery_id`='" . intval($iID) . "',
					`hat_galerie`='1',
					`date`=`date`
				WHERE `id`='" . intval($_REQUEST['eid']) . "'
			";
			db_query($query);
		}
	}  // ("saveList" == $sTodo) Ende





	echo "				<h2>Bildergalerie - " . ($iID?"&Uuml;bersicht":"hinzuf&uuml;gen") . "</h2>\n";
//	$aImages = array();
	if($iID && !$sError)
	{
		// ermittel die Galerie-Details
		$sSQL = "
			SELECT *,
				UNIX_TIMESTAMP(`created`) `created`,
				UNIX_TIMESTAMP(`modified`) `modified`,
				UNIX_TIMESTAMP(`date`) `date`
			FROM `gallery2_list`
			WHERE
				`active`='1'
				AND `id`='" . intval($iID) . "'
		";
		$rRes = db_query($sSQL);
		$aMy = get_data($rRes);
		$aList["details"]["id"] = intval($aMy["id"]);
		$aList["details"]["name"] = trim(htmlspecialchars($aMy["name"]));
		$aList["details"]["description"] = trim($aMy["description"]);
		$aList["details"]["created"] = $aMy["created"];
		$aList["details"]["date"]= $aMy["date"];
		$aList["details"]["active"] = intval($aMy["active"]);

/*
		// lies die Galerie-Bilder aus
		$sSQL = "
			SELECT
				*,
				f.`id` AS file_id
			FROM
				`gallery2_items` AS i,
				`gallery2_files` AS f
			WHERE
				list_id='" . intval($aList["details"]["id"]) . "'
				AND i.`id`=f.`item_id`
				AND f.`size_id`='0'
			ORDER BY i.`position`
		";
		$rRes = db_query($sSQL);
		while($aMy = get_data($rRes))
		{
			$aImages[intval($aMy["active"])][intval($aMy["item_id"])] = $aMy;
		}
*/
	}
	if($_REQUEST['event'])
	{
		$query = "
			SELECT *
			FROM `eventmodul_events`
			WHERE `id`='" . intval($_REQUEST['eid']) . "'
		";
		$aEventData = get_data(db_query($query));
		$aList["details"]["name"] = $aEventData['title'];
		$aList["details"]["date"] = $aEventData['date'];
		$aList["details"]["description"] = $aEventData['text'];

	}
?>
	<form id="formular" method="POST" action="<?=$_SERVER["PHP_SELF"] . "?" . rand(0, 100000);?>" enctype="multipart/form-data">
<?
	if($_REQUEST['event']) {
		echo "<input type=\"hidden\" name=\"event\" value=\"true\">";
		echo "<input type=\"hidden\" name=\"eid\" value=\"".$_REQUEST['eid']."\">";
	}
?>
		<input type="hidden" id="form_action" name="form_action" value="saveList">
		<input type="hidden" name="id" value="<?=$iID;?>">
		<input type="hidden" id="h_list" name="h_list" value="">
		<input type="hidden" id="h_trash" name="h_trash" value="">
		<table cellpadding="4" cellspacing="0" border="0" width="100%" class="table">
			<tr>
				<th style="width:40%;">Galeriename:</th>
				<td style="width:60%;"><input type="text" name="gallery_name" value="<?=$aList["details"]["name"];?>" class="txt"></td>
			</tr>
			<tr>
				<th>Galeriedatum:</th>
				<td><input type="text" name="gallery_date" value="<?
	if($aList["details"]["date"]) {
		$datestring = strftime("%x", $aList["details"]["date"]);
	}
	else {
		$datestring = strftime("%x");
	}
	echo $datestring;
?>" class="txt" /></td>
			</tr>
			<tr>
				<th>Beschreibung:</th>
				<td><textarea style="height:120px" name="gallery_description" class="txt"><?=$aList["details"]["description"];?></textarea></td>
			</tr>
<?php




	if($iID)
	{
?>
			<tr>
				<th>Bilder-Pflege</th>
				<td>
					<table cellpadding="0" cellspacing="0" border="0" width="100%">
						<tr>
							<td width="50%" align="center"><br />Bilder:</td>
							<td width="50%" align="center"><br />Papierkorb:</td>
						</tr>
						<tr>
							<td style="vertical-align:top">
								<br /><ul class="sortablelist" id="destlist1" style="width:200px;">
								</ul>
							</td>
							<td style="vertical-align:top">
								<br /><ul class="sortablelist" id="trash" style="width:200px">
								</ul>
							</td>
						</tr>
					</table>
				</td>
			</tr>
			<?=printFormText("Vorgabe Bildbeschreibung", "default_name", $_SESSION['gallery2']['default_name'], 'onKeyUp="saveDefaultName(this.value);"')?>
			<tr>
				<th>Bilder-Upload</th>
				<td><applet
						style="border:1px solid #000000;"

						code="JUpload.startup"
						archive="/admin/extensions/gallery2/jupload.jar"
						width="500"
						height="300"
						mayscript="mayscript"
						name="JUpload"
						id="JUpload"
						alt="Java Upload Tool">
						<!-- Java Plug-In Options -->
						<param name="progressbar" value="true">
						<param name="boxmessage" value="Loading Java Upload Application ...">
						<!-- Target links -->
						<param name="actionURL" value="gallery2_upload.html?id=<?=$iID;?>">
						<PARAM NAME="maxTotalRequestSize" VALUE="20000000">
						Ihr Browser ist so eingestellt, dass er kein Java unterst&uuml;tzt. Das Java-Plugin k&ouml;nnen Sie hier downloaden: <a href="http://www.java.com/">java.com</a>
				</applet></td>
			</tr>
<?php
	}
?>
				</td>
			</tr>
		</table>
				<p align="right">
					<button type="button" onClick="window.location.href='<?
					if($_REQUEST['event'])
					{
						echo "eventmodul.html?" . rand(0, 100000);
					}
					else
					{
						echo $_SERVER["PHP_SELF"] . "?" . rand(0, 100000);
					}
					?>'" class="btn">zur&uuml;ck</button>
					&nbsp;&nbsp;&nbsp;
<?php
	$sButtonText = ($iID?"speichern":"speichern und zur Bilderpflege");
?>
					<button type="button" class="btn" onClick="getListsAndSubmit();"><?=$sButtonText;?></button>
				</p>

	</form>




	<script type="text/javascript">
		<!--
<?php
	if($iID)
	{
		if("edit" == $sTodo || "saveList" == $sTodo)
		{
?>
			var rTimeOut = window.setTimeout("getDataChanges(<?=$iID;?>)", 100);
<?php
		}

?>
			function listChanged(sortable, listname)
			{
			}


<?php
	}
?>
			function getListsAndSubmit()
			{
<?php
	if($iID)
	{
?>

				var oList1 = document.getElementById('destlist1');
				var iAnzahlList1 = oList1.childNodes.length;
				var sIdsList1 = '';
				for(i = 0; i < iAnzahlList1; i++)
				{
					sIdsList1 += '|' + oList1.childNodes[i].id;
				}
				document.getElementById('h_list').value = sIdsList1;

				oTrash = document.getElementById('trash');
				var iAnzahlTrash = oTrash.childNodes.length;
				var sIdsTrash = '';
				for(i = 0; i < iAnzahlTrash; i++)
				{
					sIdsTrash += '|' + oTrash.childNodes[i].id;
				}
				document.getElementById('h_trash').value = sIdsTrash;

<?php
	}
?>
				document.getElementById('formular').submit();
			}

		//-->
<?php
	if($iID)
	{
?>
		// <![CDATA[
			Sortable.create("destlist1", {
				dropOnEmpty:true, containment:["destlist1", "trash"], ghosting:false,
				constraint:false, onUpdate:function(element){listChanged(element, 'destlist1')}
			});
			Sortable.create("trash", {
				dropOnEmpty:true, containment:["destlist1", "trash"], ghosting:false,
				constraint:false, onUpdate:function(element){listChanged(element, 'trash')}
			});
		// ]]>
<?php
	}
?>
	</script>
<?php
}












// ansonsten die Liste aller Galerien ausgeben
else
{
	// Wenn eine Galerie aus der Liste geloescht werden soll
	if($iID && "delete" == $sTodo)
	{
		$sSQL = "UPDATE `gallery2_list`" .
			" SET `active`='2'" .
			" WHERE `id`='" . intval($iID) . "'";
		db_query($sSQL);
	}

	echo "				<h2>Bildergalerien</h2>\n";

	if ($_VARS['page_id'] && $_VARS['element_id'] && $_VARS['content_id'])
	{
		if(isset($_VARS['action']) && $_VARS['action'] == 'save_galery2_pagination_limit')
		{
			$oConfig = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
			$oConfig->galery2_pagination_limit = $_VARS['galery2_pagination_limit'];
			$oConfig->save_config($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
		}

		$oConfig = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
?>
		<form method="post" action="">
			<div style="padding:3px; border: 1px solid #CCC; margin-bottom:20px;">
				<div style="float:left;">
					<input type="hidden" name="action" value="save_galery2_pagination_limit" />
					<input class="txt" style="width:50px;" name="galery2_pagination_limit" value="<?=$oConfig->galery2_pagination_limit?>" />
					Bitte geben Sie hier ein Limit ein, der in der Listenansicht berücksichtigt wird (0 = kein Limit)
				</div>
				<div style="float:right;">
					<input type="submit" class="btn" style="margin:0;" value="Limit speichern" />
				</div>
				<div style="clear:both;"></div>
			</div>
		</form>
<?
	}

	// News-Liste konfigurieren
	$sHeadline = "";
	$aColumnNames = array(
		"ID",
		"Name",
		"Datum",
		"Aktion"
	);
	$aDBColumnNames = array(
		"id",
		"id",
		"name",
		"date"
	);
	$aColumnFunctions = array(
		"",
		"",
		create_function('$date', 'return strftime("%x",$date);')
	);
	$aColumnWidths = false;
	$sSQLquery = "
		SELECT
			`id`,
			`name`,
			UNIX_TIMESTAMP(`date`) AS date
		FROM `gallery2_list`
		WHERE `active`='1'
	";
	$sEditAction = "edit";
	$sDeleteAction = "delete";
	$aButtons = array("hinzuf&uuml;gen|edit", "Einstellungen|settings");
	$sDefaultOrder = "date DESC";
	$iPerPage = 20;
	$bShowTopNavi = false;

	// News-Liste ausgeben
	printTableList(
		$sHeadline,
		$aColumnNames,
		$aDBColumnNames,
		$aColumnWidths,
		$sSQLquery,
		$sEditAction,
		$sDeleteAction,
		$aButtons,
		$aColumnAligns='',
		$aColumnFunctions,			// ='',
		$asAdvancedSQLQuery='',
		$sDefaultOrder,				// ='',
		$iPerPage,					// =0,
		$bNoWrap=false,
		$sGetParam,
		$aPostParam='',
		$bNewWindow=false,
		$bShowTopNavi,				// =true,
		$sDatabase=false
	);
}












// Standard Admin Ende
?>
			</td>
		</tr>
	</table>
</body>
</html>