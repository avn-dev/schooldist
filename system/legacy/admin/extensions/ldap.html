<?

include(\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Access_Backend::checkAccess("modules_admin");

Admin_Html::loadAdminHeader();

function saveLdapConfig($sField, $mValue) {
	
	db_query("DELETE FROM system_config WHERE c_key = '".\DB::escapeQueryString($sField)."'");
	db_query("INSERT INTO system_config SET c_value = '".\DB::escapeQueryString($mValue)."', c_key = '".\DB::escapeQueryString($sField)."'");

}

if($_VARS['task'] == 'save') {
	
	saveLdapConfig('ldap_host', $_VARS['ldap_host']);
	saveLdapConfig('ldap_base_dn', $_VARS['ldap_base_dn']);
	saveLdapConfig('ldap_default_role', $_VARS['ldap_default_role']);
	saveLdapConfig('ldap_user', $_VARS['ldap_user']);
	saveLdapConfig('ldap_pass', $_VARS['ldap_pass']);
	saveLdapConfig('ldap_search', $_VARS['ldap_search']);
	saveLdapConfig('ldap_env_variable', $_VARS['ldap_env_variable']);

	saveLdapConfig('ldap_field_username', $_VARS['ldap_field_username']);
	saveLdapConfig('ldap_field_email', $_VARS['ldap_field_email']);
	saveLdapConfig('ldap_field_password', $_VARS['ldap_field_password']);
	saveLdapConfig('ldap_field_firstname', $_VARS['ldap_field_firstname']);
	saveLdapConfig('ldap_field_lastname', $_VARS['ldap_field_lastname']);

}

$aItems = DB::getQueryData("SELECT * FROM system_config WHERE c_key LIKE 'ldap_%'");

$aConfig = array();

foreach((array)$aItems as $aItem) {
	$aConfig[$aItem['c_key']] = $aItem['c_value'];
}

?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
	<tr>
		<td valign="top">
			<h1>LDAP</h1>

			<form method="post" action="<?=$_SERVER['PHP_SELF']?>">

				<?=printFormHidden("task", "save")?>
				<?=printTableStart()?>
					<?=printFormText(L10N::t('Host'), 'ldap_host', $aConfig['ldap_host'])?>
					<?=printFormText(L10N::t('BaseDN'), 'ldap_base_dn', $aConfig['ldap_base_dn'])?>
					<?=printFormText(L10N::t('Username'), 'ldap_user', $aConfig['ldap_user'])?>
					<?=printFormText(L10N::t('Password'), 'ldap_pass', $aConfig['ldap_pass'])?>
					<?=printFormText(L10N::t('Usergroup ID'), 'ldap_default_role', $aConfig['ldap_default_role'])?>
					<?=printFormText(L10N::t('Search pattern (f.e. "(CN={USERNAME})")'), 'ldap_search', $aConfig['ldap_search'])?>
					<?=printFormText(L10N::t('_SERVER Part (Auto login)'), 'ldap_env_variable', $aConfig['ldap_env_variable'])?>
				<?=printTableEnd()?>
				<br/>
				<?=printTableStart()?>
					<?=printFormText(L10N::t('Username'), 'ldap_field_username', $aConfig['ldap_field_username'])?>
					<?=printFormText(L10N::t('E-Mail'), 'ldap_field_email', $aConfig['ldap_field_email'])?>
					<?=printFormText(L10N::t('Password'), 'ldap_field_password', $aConfig['ldap_field_password'])?>
					<?=printFormText(L10N::t('Firstname'), 'ldap_field_firstname', $aConfig['ldap_field_firstname'])?>
					<?=printFormText(L10N::t('Lastname'), 'ldap_field_lastname', $aConfig['ldap_field_lastname'])?>
				<?=printTableEnd()?>

				<?=printSubmit(L10N::t('save'))?>

			</form>

		</td>
	</tr>
</table>
<?=Admin_Html::loadAdminFooter()?>