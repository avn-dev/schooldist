<?php


// Includes
include_once $_SERVER["DOCUMENT_ROOT"]."/system/extensions/luisenhospital/functions_lh.inc.php";


// Konstanten
$sFotoPfad = "/media/lh/news/";
$sDBTable = "lh_news";


// Includes
include("../includes/main.inc.php");


Access_Backend::checkAccess("lh_news");


// Uebergabewerte auslesen
$iID = intval($_VARS["id"]);
$sTodo = trim($_VARS["form_action"]);


// Standard Admin Anfang
Admin_Html::loadAdminHeader();
?>
<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
	<tr>
		<td valign="top">
			<h1>Meldungen-Administration</h1><br /><br />
<?php






// Error-Text initialisieren
$sError = "";



// If this id is to be set as TopNews (only one of those may exist at a given time)
if ("topnews" == $sTodo) {
	// Remove all existing TopNews
	$sSQL = "UPDATE `" . $sDBTable . "`" .
		" SET `isTopNews`='0'" .
		" WHERE `isTopNews`='1'";
	db_query($sSQL);
	// Set the current ID as TopNews
	$sSQL = "UPDATE `" . $sDBTable . "`" .
		" SET `isTopNews`='1'" .
		" WHERE `id`='" . $iID . "'";
	db_query($sSQL);
}




// Wenn die Daten gespeichert werden sollen
if("save" == $sTodo)
{
	$aNews["datum"] = trim($_VARS["sDate"]);
	$aNews["datum"] = convertGermanToSQLDate($aNews["datum"]);
	if(!$sDate)
	{
		$sError .= "Das Datum ist nicht angegeben bzw. im falschen Format!<br />";
	}
	$aNews["ueberschrift_kurz"] = trim($_VARS["sHeadlineShort"]);
	if(!$aNews["ueberschrift_kurz"])
	{
		$sError .= "Die Kurz&uuml;berschrift ist nicht angegeben!<br />";
	}
	$aNews["ueberschrift"] = trim($_VARS["sHeadline"]);
	$aNews["vorwort"] = trim($_VARS["sPreamble"]);
	$aNews["spalte_links"] = trim($_VARS["sColumnLeft"]);
	$aNews["spalte_rechts"] = trim($_VARS["sColumnRight"]);
	$aNews["isNews"] = trim($_VARS["sIsNews"]);
	if ($aNews["isNews"] != "1") {
		$aNews["isNews"] = "0";
	}
	/*$aNews["isTopNews"] = trim($_VARS["sIsTopNews"]);
	if ($aNews["isTopNews"] != "1") {
		$aNews["isTopNews"] = "0";
	}*/

	$aNews["pdf"] = trim($_VARS["sPDF"]);
	$sNewPDF = trim($_VARS["sNewPDF"]["name"]);
	if($sNewPDF)
	{
		if($_FILES["sNewPDF"]["size"])
		{
			$sRealPFile = $_FILES["sNewPDF"]["name"];
			$sRealPFilename = substr($sRealPFile, 0, strrpos($sRealPFile, '.'));
			$sPExtention = substr($sRealPFile, strrpos($sRealPFile, '.'));
			$sNewPFile = "np_" . fillZeros($iID, 5) . ".pdf";
			$sNewPPath = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewPFile;
			move_uploaded_file($_FILES["sNewPDF"]["tmp_name"], $sNewPPath);
			if(file_exists($sNewPPath))
			{
				$aNews["pdf"] = $sNewPFile;
			}
			else
			{
				$sError .= "Das Pdf konnte nicht gespeichert werden!<br />";
			}
		}
		else
		{
			$sError .= "Das Pdf wurde nicht &uuml;bertragen!<br />";
			$sRealPFilename = $aNews["pdf"];
		}
	}
	else
	{
		$sRealPFilename = $aNews["pdf"];
	}

	$sNewImage = trim($_VARS["sNewImage"]["name"]);
	if($sNewImage)
	{
		if($_FILES["sNewImage"]["size"])
		{
			$sRealFile = $_FILES["sNewImage"]["name"];
			$sExtention = substr($sRealFile, strrpos($sRealFile, '.'));
			$sTempFile = "_temp" . $sExtention;
			$sTempPath = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sTempFile;
			move_uploaded_file($_FILES["sNewImage"]["tmp_name"], $sTempPath);
			if(file_exists($sTempPath))
			{
				$sNewFile = "nf_" . ($iID?fillZeros($iID, 5):"_" . rand(100, 999) . "_") . ".jpg";
				$sNewPath = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewFile;
				convertImage(339, "*", $sTempPath, $sNewPath, $system_data['im_path']);
			}
			else
			{
				$sError .= "Das Bild f&uuml;r die rechte Spalte konnte nicht gespeichert werden!<br />";
			}
		}
		else
		{
			$sError .= "Das Bild f&uuml;r die rechte Spalte wurde nicht &uuml;bertragen!<br />";
		}
	}

	$sNewImageStart = trim($_VARS["sNewImageStart"]["name"]);
	if($sNewImageStart)
	{
		if($_FILES["sNewImageStart"]["size"])
		{
			$sRealFileStart = $_FILES["sNewImageStart"]["name"];
			$sExtentionStart = substr($sRealFileStart, strrpos($sRealFileStart, '.'));
			$sTempFile = "_temp" . $sExtentionStart;
			$sTempPath = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sTempFile;
			move_uploaded_file($_FILES["sNewImageStart"]["tmp_name"], $sTempPath);
			if(file_exists($sTempPath))
			{
				$sNewFileStart = "ni_" . ($iID?fillZeros($iID, 5):"_" . rand(100, 999) . "_") . ".jpg";
				$sNewPathStart = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewFileStart;
				convertImage(209, 109, $sTempPath, $sNewPathStart, $system_data['im_path']);
			}
			else
			{
				$sError .= "Das Bild f&uuml;r die Startseite konnte nicht gespeichert werden!<br />";
			}
		}
		else
		{
			$sError .= "Das Bild f&uuml;r die Startseite wurde nicht &uuml;bertragen!<br />";
		}
	}

	if($sError)
	{
		echo "<span style='color:red'>" . $sError . "</span>\n";
	}
	else
	{
		$sSQL = "`" . $sDBTable . "`" .
			" SET `datum`='" . addslashes($aNews["datum"]) . "'" .
			", `ueberschrift_kurz`='" . addslashes($aNews["ueberschrift_kurz"]) . "'" .
			", `ueberschrift`='" . addslashes($aNews["ueberschrift"]) . "'" .
			", `vorwort`='" . addslashes($aNews["vorwort"]) . "'" .
			", `spalte_links`='" . addslashes($aNews["spalte_links"]) . "'" .
			", `spalte_rechts`='" . addslashes($aNews["spalte_rechts"]) . "'" .
			", `pdf`='" . addslashes($sRealPFilename) . "'" .
			", `isNews`='" . addslashes($aNews["isNews"]) . "'" .
			/*", `isTopNews`='" . addslashes($aNews["isTopNews"]) . "'" .*/
			", `active`='1'";
		if($iID)
		{
			$sSQL = "UPDATE " . $sSQL . " WHERE `id`='" . $iID . "'";
		}
		else
		{
			$sSQL = "INSERT INTO " . $sSQL;
		}
		db_query($sSQL);

		if(!$iID)
		{
			$iID = get_insert_id();

			if($sNewImageStart)
			{
				$sNewFile2Start = "ni_" . fillZeros($iID, 5) . ".jpg";
				$sNewPath2Start = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewFile2Start;
				rename($sNewPathStart, $sNewPath2Start);
			}

			if($sNewImage)
			{
				$sNewFile2 = "nf_" . fillZeros($iID, 5) . ".jpg";
				$sNewPath2 = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewFile2;
				rename($sNewPath, $sNewPath2);
			}

			if($sNewPDF)
			{
				$sNewPFile2 = "np_" . fillZeros($iID, 5) . ".pdf";
				$sNewPPath2 = $_SERVER["DOCUMENT_ROOT"] . $sFotoPfad . $sNewPFile2;
				rename($sNewPPath, $sNewPPath2);
				$sSQL = "UPDATE `" . $sDBTable . "`" .
					" SET `pdf`='" . addslashes($sNewPFile2) . "'" .
					" WHERE `id`='" . $iID . "'" .
					"  AND `active`='1'";
				db_query($sSQL);
			}
		}

		echo "<span>Die Daten wurden gespeichert.</span>\n";
	}
	$sTodo = "edit";
}






// Wenn Daten aus der Liste geloescht werden sollen
if($iID && "delete" == $sTodo)
{
	$sSQL = "UPDATE `" . $sDBTable . "`" .
		" SET `active`='2'" .
		" WHERE `id`='" . $iID . "'";
	db_query($sSQL);
}






// Wenn die Daten editiert werden sollen, ...
if("edit" == $sTodo)
{
	echo "			<h2>Meldung" . ($iID?"sdetails":" hinzuf&uuml;gen") . "</h2>\n";
	if($iID && !$sError)
	{
		$sSQL = "SELECT * FROM `" . $sDBTable . "` WHERE `active`='1' AND `id`='" . $iID . "'";
		$rSQL = db_query($sSQL);
		$aNews = get_data($rSQL);
	}
	if (!$iID && !$sError) {
		$aNews["isNews"] = "1";
	}
?>
			<form method="POST" action="<?=$_SERVER["PHP_SELF"];?>" enctype="multipart/form-data">
				<input type="hidden" name="form_action" value="save">
				<input type="hidden" name="id" value="<?=$iID;?>">
<?php
	printTableStart();
	if($aNews["datum"])
	{
		$sDate = convertSQLToGermanDate($aNews["datum"]);
	}
	else
	{
		$sDate = date("d.m.Y");
	}
	printFormText("Datum *)", "sDate", $sDate);
	printFormCheckbox("Aktuelles und Archiv", "sIsNews", "1", ($aNews["isNews"]=="1"));
	//printFormCheckbox("Sondermeldung", "sIsTopNews", "1", ($aNews["isTopNews"]=="1"));
	printFormText("Kurz&uuml;berschrift *)", "sHeadlineShort", trim($aNews["ueberschrift_kurz"]));
	printFormText("&Uuml;berschrift", "sHeadline", $aNews["ueberschrift"]);
	printFormHTMLarea("Vorwort", "sPreamble", $aNews["vorwort"]);
	printFormHTMLarea("linke Spalte", "sColumnLeft", $aNews["spalte_links"]);
	printFormHTMLarea("rechte Spalte", "sColumnRight", $aNews["spalte_rechts"]);
?>
		<tr>
			<th width="40%">PDF</th>
			<td width="60%">
				<input type="hidden" name="sPDF" value="<?=$aNews["pdf"];?>" />
				<input type="file" name="sNewPDF" class="txt" accept="application/pdf" />
<?php
	$sFname = $sFotoPfad . "np_" . fillZeros($aNews["id"], 5) . ".pdf";
	if(file_exists($_SERVER["DOCUMENT_ROOT"] . $sFname))
	{
		echo "				<br /><a href=\"" . $sFname . "\" target=\"pdf\">aktuelles PDF</a>\n";
	}
?>
			</td>
		</tr>
		<tr>
			<th width="40%">Bild f&uuml;r die rechte Spalte</th>
			<td width="60%">
				<input type="hidden" name="sImage" value="<?=$aNews["bild"];?>" />
				<input type="file" name="sNewImage" class="txt" />
<?php
	$aImageFile = "nf_" . fillZeros($aNews["id"], 5) . ".jpg";
	$aImagePath = $sFotoPfad . $aImageFile;
	if(file_exists($_SERVER["DOCUMENT_ROOT"] . $aImagePath))
	{
		echo "				<br /><br /><img src=\"" . $aImagePath . "\" width=\"209\" alt=\"News-Bild\" border=\"0\" />\n";
	}
?>
 			</td>
		</tr>
		<tr>
			<th width="40%">Bild f&uuml;r die Startseite</th>
			<td width="60%">
				<input type="hidden" name="sImageStart" value="<?=$aNews["bild_startseite"];?>" />
				<input type="file" name="sNewImageStart" class="txt" />
<?php
	$aImageStartFile = "ni_" . fillZeros($aNews["id"], 5) . ".jpg";
	$aImageStartPath = $sFotoPfad . $aImageStartFile;
	if(file_exists($_SERVER["DOCUMENT_ROOT"] . $aImageStartPath))
	{
		echo "				<br /><br /><img src=\"" . $aImageStartPath . "\" width=\"209\" alt=\"News-Bild\" border=\"0\" />\n";
	}
?>
 			</td>
		</tr>
<?
	printTableEnd();
	echo "		<br /><span>*) Pflichtfelder</span>";
	printSubmit("Meldung speichern");
?>
				<button type="button" onClick="window.location.href='<?=$_SERVER["PHP_SELF"];?>'" class="btn">zur&uuml;ck</button>
			</form>
<?php
}






// ansonsten die Liste ausgeben
else
{
	echo "			<h2>Meldungsliste</h2>\n";
	// News-Liste konfigurieren
	$sHeadline = "";
	$aColumnNames = array(
		"Datum",
		"kurze &Uuml;berschrift",
		"Sondermeldung",
		"Aktion"
	);
	$aDBColumnNames = array(
		"id",
		"datum",
		"ueberschrift_kurz",
		"isTopNews"
	);
	$aColumnWidths = false;
	$sSQLquery = "SELECT * FROM `" . $sDBTable . "` WHERE `active`='1'";
	//$asEditAction = array();
	$asEditAction[0] = "edit";
	$asEditAction[1] = "topnews|/admin/media/messagebox_warning.png|||Sondermeldung";
	$sDeleteAction = "delete";
	$aButtons = array("hinzuf&uuml;gen|edit");
	$aColumnFunctions = array(
		"convertSQLToGermanDate",
		false,
		"getDescriptionForIntegerFlag"
	);
	$sDefaultOrder = "datum DESC";
	$iPerPage = 20;
	$bShowTopNavi = false;


	// News-Liste ausgeben
	printTableList(
		$sHeadline,
		$aColumnNames,
		$aDBColumnNames,
		$aColumnWidths,
		$sSQLquery,
		$asEditAction,
		$sDeleteAction,
		$aButtons,
		$aColumnAligns='',
		$aColumnFunctions,			// ='',
		$asAdvancedSQLQuery='',
		$sDefaultOrder,				// ='',
		$iPerPage,					// =0,
		$bNoWrap=false,
		$sGetParam='',
		$aPostParam='',
		$bNewWindow=false,
		$bShowTopNavi,				// =true,
		$sDatabase=false
	);
}






// Standard Admin Ende
?>
		</td>
	</tr>
</table>
<?php
Admin_Html::loadAdminFooter();


?>