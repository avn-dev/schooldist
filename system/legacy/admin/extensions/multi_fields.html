<?php

include("../includes/main.inc.php");

Access_Backend::checkAccess("multi");

include_once("./multi.inc.html");

Admin_Html::loadAdminHeader();

$form_active_id = (int)$_VARS['form_active_id'];
$form_loesch_id = (string)$_VARS['form_loesch_id'];

//aktivieren/deaktivieren bearbeiten
if($form_active_id > 0){
	DB::executeQuery("UPDATE multi_fields SET active = '$form_active' WHERE id = '$form_active_id'");
	// Datentabelle neu schreiben
	Ext_Multi::writeMultiDataTable($_VARS['multi_id']);
}//if

//Einträge löschen
if(!empty($form_loesch_id)) {
//id's extrahieren
$form_loesch_id = explode("|",$form_loesch_id);
	for($i=0;$i<=count($form_loesch_id);$i++) {
		if($form_loesch_id[$i] > 0) {
			DB::executeQuery("DELETE FROM multi_fields WHERE id = '$form_loesch_id[$i]'");
		}//if
	}//for
	// Datentabelle neu schreiben
	Ext_Multi::writeMultiDataTable($_VARS['multi_id']);
}//if

$multi_id = $_VARS['multi_id'];

if($_VARS['action'] == "setposition") {

	changePosition($_VARS['dir'],$_VARS['id'],"multi_fields","WHERE multi_id = ".(int)$_VARS['multi_id']."", "module");
	// Datentabelle neu schreiben
	Ext_Multi::writeMultiDataTable($_VARS['multi_id']);
}

?>
<style>
	body {
		background-color: #ffffff!important;
	}
.newfolder {
	border-bottom: 1px solid black;
	border-right: 1px solid black;
	border-top: 1px solid black;
	border-left: 1px solid black;
}
.select_on {
	background-color: buttonface;
	border-bottom: 1px solid buttonhighlight;
	border-right: 1px solid buttonhighlight;
	border-top: 1px solid buttonshadow;
	border-left: 1px solid buttonshadow;
}
.select_off {
	background-color: buttonface;
	border-top: 1px solid buttonhighlight;
	border-left: 1px solid buttonhighlight;
	border-bottom: 1px solid buttonshadow;
	border-right: 1px solid buttonshadow;
}
td, th {
	padding: 2px;
}
</style>
<script>

var folder = "<? echo $folder; ?>";
/**
 * Sets/unsets the pointer in browse mode
 *
 * @param   object   the table row
 * @param   object   the color to use for this row
 * @param   object   the background color
 *
 * @return  boolean  whether pointer is set or not
 */
var delete_media = new Array();
 
function setPointer(theRow, thePointerColor, theNormalBgColor) {

	for (var i=0;i<document.getElementsByTagName("tr").length;i++) {
		var a = eval("document.getElementsByTagName('tr')["+i+"];");
		if(a.id != "") {
		    var theCells = null;
		
		    if(thePointerColor == '' || typeof(a.style) == 'undefined') {
		        return false;
		    }
		    if(typeof(document.getElementsByTagName) != 'undefined') {
		        theCells = a.getElementsByTagName('td');
		    } else if (typeof(theRow.cells) != 'undefined') {
		        theCells = a.cells;
		    } else {
		        return false;
		    }
		    var rowCellsCnt  = theCells.length;
		    var currentColor = null;
		    var newColor     = null;
			var newTextColor = '#AAAAAA';
		    // Opera does not return valid values with "getAttribute"
			currentColor = theCells[0].style.backgroundColor;
	        newColor     = theNormalBgColor;
	        newTextColor = '#AAAAAA';
	        delete_media[a.id] = '0';

	        for (var c = 0; c < rowCellsCnt; c++) {
				theCells[c].style.backgroundColor = newColor;
				theCells[c].style.color = newTextColor;
	        } // end for
		}
	}

    var theCells = null;

    if (thePointerColor == '' || typeof(theRow.style) == 'undefined') {
        return false;
    }

	if (typeof(document.getElementsByTagName) != 'undefined') {
        theCells = theRow.getElementsByTagName('td');
    } else if (typeof(theRow.cells) != 'undefined') {
        theCells = theRow.cells;
    } else {
        return false;
    }

    var rowCellsCnt  = theCells.length;
    var currentColor = null;
    var newColor     = null;
	var newTextColor = '#000000';
    // Opera does not return valid values with "getAttribute"
	currentColor = theCells[0].style.backgroundColor;
    newColor     = (currentColor.toLowerCase() == thePointerColor.toLowerCase())
                 ? theNormalBgColor
                 : thePointerColor;
    newTextColor     = (currentColor.toLowerCase() == thePointerColor.toLowerCase())
                 ? '#AAAAAA'
                 : '#000000';
    delete_media[theRow.id] = (currentColor.toLowerCase() == thePointerColor.toLowerCase())
                 ? 0
                 : 1;
    for (var c = 0; c < rowCellsCnt; c++) {
		theCells[c].style.backgroundColor = newColor;
		theCells[c].style.color = newTextColor;
    } // end for

    return true;
} // end of the 'setPointer()' function

function upd_file_prefs(entry_id){
	top.frames[0].document.form_form_1.entry_id.value = entry_id;
}

function deleteitem() {
	 var count = 0;
	 var loeschen = "|";
	 for(i=0;i<=delete_media.length;i++) {
	 if(delete_media[i] == 1) {
	 count++;
	 loeschen +=  i + "|";
	 }
	 }
	 if(count>1) {
	 var text = "Möchten Sie diese " + count + " Felder wirklich entfernen?";
	  var check = confirm(text);
	 } 
	if(count==1) {
	 var text = "Möchten Sie dieses Feld wirklich entfernen?";
	  var check = confirm(text);
	 }
	 if(count==0) {
		var text = "Es ist kein Feld markiert!";
		alert(text);
	 }  
	if(check) {
		document.location.href='<?=$_SERVER['PHP_SELF']?>?multi_id=<?=$_VARS['multi_id']?>&form_loesch_id=' + loeschen;
	}
}

function upd_form_data(entry_id){
	parent.document.multi_form_1.entry_id.value = entry_id;
}
</script>
<script for="document" event="onkeydown()" language="JScript" type="text/jscript">
<!--
 {
 if(window.event.keyCode == "46") {
deleteitem();
  }
 }
//-->
</script>
<script>

var loading;
var imagetypes = "jpg|png|gif|tif|bmp";

</script>

<table cellpadding="1" cellspacing="0" border="0" width="100%" style="table-layout : fixed;">
	<tr style="cursor:pointer;">
		<td style="width:80px;" class=select_off>ID</td>
		<td style="width:auto;" class=select_off>Name</td>
		<td style="width:250px;" class=select_off>Typ</td>
		<td style="width:100px;" class=select_off>Anzeige</td>
		<td style="width:70px;" class=select_off>Position</td>		
	</tr>
<?

//Daten holen
$form_abfrage = DB::getQueryRows("SELECT * FROM multi_fields WHERE multi_id = ".(int)$_VARS['multi_id']." ORDER BY position");
foreach($form_abfrage as $aFields) {

	if($aFields['field_id'] == "0") {
		DB::executeQuery("UPDATE multi_fields SET field_id = ".(int)$aFields['id']." WHERE id = ".(int)$aFields['id']."");
	}

	//Grafik und Link für active/deactive
	if($aFields['active'] == 1){
		$form_active_gra = "sitemap_active.gif";
		$form_active_link = $_SERVER['PHP_SELF']."?page_id=".$page_id."&element_id=".$element_id."&form_active_id=".$aFields['id']."&form_active=2";
	} else {
		$form_active_gra = "sitemap_deactive.gif";
		$form_active_link = $_SERVER['PHP_SELF']."?page_id=".$page_id."&element_id=".$element_id."&form_active_id=".$aFields['id']."&form_active=1";
	}//else

	//Listeneinträge erzeugen
	echo "<tr style=\"cursor:default;\" id=\"".$aFields['id']."\" onclick=\"setPointer(this, 'ACTIVECAPTION', '#FFFFFF'); upd_form_data('".$aFields['id']."');\">";
	echo "<td nowrap align=right>".$aFields['field_id']."</td>";
	echo "<td nowrap>".$aFields['name']."</td>";
	echo "<td nowrap>".$aMultiTypes[$aFields['type']]."</td>";
	echo "<td nowrap>".$aFields['display']."</td>";
	echo "
	<td nowrap align=\"center\"><img src=/admin/media/spacer.gif width=3 height=1>
		<a href=".$_SERVER['PHP_SELF']."?form_action=entries&multi_id=".$_VARS['multi_id']."&action=setposition&dir=up&id=".$aFields['id']."><img src=\"/admin/media/sitemap_up.png\" border=0 alt=top></a>
		<a href=".$_SERVER['PHP_SELF']."?form_action=entries&multi_id=".$_VARS['multi_id']."&action=setposition&dir=down&id=".$aFields['id']."><img src=\"/admin/media/sitemap_down.png\" border=0 alt=down></a>&nbsp;
	</td>\n";

}//while
?>	
</table>
<?=Admin_Html::loadAdminFooter()?>