<?php
include "../includes/main.inc.php";
include "../../system/includes/sajax.inc.php";
?>
<?=Admin_Html::loadAdminHeader()?>
<table cellpadding="0" cellspacing="30" border="0" width="100%">
	<tr>
		<td valign="top">
			<h1>News-Administration</h1>
			<p>


<?
function printFormOptionalText($title, $name, $value="", $parameter="", $fid=0, $onerow=1, $idHelp=0)
{
  global $_VARS;
  $parameter.=">&nbsp&nbsp&nbsp" .
        "<img src=\"/admin/media/edit.png\" border=\"0\" onclick=\"showPrompt('".$fid."');\">" .
          "<a href=\"javascript:if(confirm('Wollen Sie diesen Eintrag wirklich löschen?')) document.location.href='newsmodul.html?form_action=edit&item=delete&id=".$_VARS["id"]."&fid=".$fid."';\">".
        "<img src=\"/admin/media/delete.png\" border=\"0\">" .
      "</a";
  printFormText($title, $name, $value, $parameter, $onerow, $idHelp);
}

if ($_VARS['page_id'] && $_VARS['element_id']) {
	echo "test";
	if ($_POST['action'] == "config") {
		$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
		$config->news_id = $_VARS['news_id'];
		$config->save_config($_VARS['page_id'], $_VARS['element_id']);
	}
	$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

	$aNews = array();
	$res = db_query("SELECT * FROM news_init ORDER BY id DESC");
	while($my = get_data($res)) {
		$aNews[$my['id']] = $my['name'];
	}

?>
			<form method="POST" action="newsmodul.html">
			<input type="hidden" name="action" value="config">
			<input type="hidden" name="page_id" value="<?=$_VARS['page_id']?>">
			<input type="hidden" name="element_id" value="<?=$_VARS['element_id']?>">
			<?=printTableStart()?>
			<?=printFormSelect("Formular", "news_id", $aNews, $config->news_id)?>
			<?=printTableEnd()?>
			<?=printSubmit("Konfiguration speichern")?>
			</form>
<?
}
else {
echo "<h2>News</h2>\n";
  $sTodo = trim($_VARS["form_action"]);
  $iID = intval($_VARS["id"]);



  if("show"== $sTodo)
  {
    if($_VARS['action']=="edit")
    {
      ?><form name="formular" method="POST" action="<?=$_SERVER["PHP_SELF"] . "?" . rand(0, 100000);?>" enctype="multipart/form-data"><?
        printTableStart();
          $sSQL= "" .
              "SELECT * " .
              "FROM news_options " .
              "WHERE (news_id = 0 " .
              "OR news_id = ".$iID.")" .
              "AND active = 1";
          $rResOptions = db_query($sSQL);

          $sSQL= "" .
              "SELECT * " .
              "FROM news_data " .
              "WHERE id='".$_VARS['fid']."'".
              "AND active = '1'";
          $rResData= get_data(db_query($sSQL));
          while($aMyData=get_data($rResOptions)){
            switch($aMyData['type']){
              case "date":
				$datestring=mktime(substr($rResData["field_".$aMyData['id']], 8, 2), substr($rResData["field_".$aMyData['id']], 10, 2), substr($rResData["field_".$aMyData['id']], 12, 2), substr($rResData["field_".$aMyData['id']], 4, 2), substr($rResData["field_".$aMyData['id']], 6, 2), substr($rResData["field_".$aMyData['id']], 0, 4));
                printFormDate($aMyData['name'], "field_".$aMyData['id'], $datestring);
                break;
              case "text":
                printFormText($aMyData['name'], "field_".$aMyData['id'], $rResData["field_".$aMyData['id']]);
                break;
              case "html":
              	printFormHTMLarea($aMyData['name'], "field_".$aMyData['id'], $rResData["field_".$aMyData['id']]);
              	break;
              case "image":
                printFormImage($aMyData['name'], "field_".$aMyData['id'], $rResData["field_".$aMyData['id']]);
                break;
              case "checkbox":
              	printFormCheckbox($aMyData['name'], "field_".$aMyData['id'], "1", $rResData["field_".$aMyData['id']]);
            }
          }
          echo
              "<tr>" .
              "<td colspan=\"2\" align=\"center\">" .
                "<input type=hidden name=form_action value=show>" .
                "<input type=hidden name=id value=".$iID.">" .
                "<input type=hidden name=fid value=".$fid.
                "><input type=submit name=\"item\" value=\"speichern\">" .
                "&nbsp;&nbsp;&nbsp;" .
                "<input type=button value=\"back\" onclick=\"location='newsmodul.html?form_action=show&id=".$iID."'\">" .
              "</td>" .
              "</tr>";
        printTableEnd();
        echo "</form>";
    }
    else
    {
      if($_VARS['action']=="delete"){
        if($_VARS['fid']){
          $sSQL= "UPDATE news_data SET active='0' WHERE id='".$_VARS['fid']."'";
          db_query($sSQL);
        }
      }

      if($_VARS['item']=="speichern")
      {
        if($_VARS['fid'])
        {
          $sSQL= "SELECT  * " .
              "FROM news_options " .
              "WHERE (news_id = 0 " .
              "OR news_id = ".$iID.") " .
              "AND active = 1 " .
              " ORDER BY id";
          $rRes = db_query($sSQL);
          $sSQL = "UPDATE news_data SET ";
          while($aMyData=get_data($rRes))
          {
            if($aMyData['type']=="date")
            {
            $sSQL.="field_".$aMyData['id']." = FROM_UNIXTIME('".strtotimestamp(trim($_VARS["field_".$aMyData['id']]))."'), ";
            }
            elseif($aMyData['type']=="checkbox"){
			$sSQL.="field_".$aMyData['id']." = '".$_VARS["field_".$aMyData['id']]."', ";
            }
			else
			{
            $sSQL.="field_".$aMyData['id']." = '".$_VARS["field_".$aMyData['id']]."', ";
			}
          }
          $sSQL=substr($sSQL, 0, (strlen($sSQL)-2));
          $sSQL.=" WHERE `id` = '".$_VARS['fid']."'";
          db_query($sSQL);
        }
        else
        {
          $sSQL= "SELECT  * " .
              "FROM news_options " .
              "WHERE (news_id = 0 " .
              "OR news_id = ".$iID.") " .
              "AND active = 1 " .
              " ORDER BY id";
          $rRes = db_query($sSQL);
          $sSQL = "INSERT INTO news_data (";
          while($aMyData=get_data($rRes))
          {
            $sInhaltSQL.= "field_".$aMyData['id'].", ";
            if($aMyData['type']=="date"){$datetemp[$aMyData['id']]=true;}
            $sFelderSQL[]= "field_".$aMyData['id'];
          }
          $sSQL.=$sInhaltSQL."active, news_id) ";
          for($i=0; $i<count($sFelderSQL); $i++){
            if($_VARS[$sFelderSQL[$i]])
            {
            	if($datetemp[substr($sFelderSQL[$i], 6)])
            	{
                	$stempSQL.="FROM_UNIXTIME('".strtotimestamp(trim($_VARS[$sFelderSQL[$i]]))."'), ";
            	}
            	else{
                	$stempSQL.="'".$_VARS[$sFelderSQL[$i]]."', ";
            	}
            }
            else
            {
            	//�bergangsl�sung
              if($sFelderSQL[$i]=="field_6")
              {
              	$stempSQL.="'0', ";
              }
              else{$stempSQL.="'', ";}
            }
          }
          $sSQL.="VALUES (".$stempSQL."'1', '".$iID."')";
          db_query($sSQL);
        }
      }
      echo "<h3><a href=\"newsmodul.html?form_action=edit&id=".$iID."\">Editieren</a></h3><br>";
      // News-Liste konfigurieren
      $sHeadline = "";
      $aColumnNames = array(
        "Datum",
        "Titel",
        "Kurzbeschreibung",
        "Aktion"
      );
      $aDBColumnNames = array(
        "id",
        "field_1",
        "field_2",
        "field_3"

      );
      $aColumnFunctions = array(
		create_function('$date', 'return date("d.m.Y",mktime(substr($date, 8, 2), substr($date, 10, 2), substr($date, 12, 2), substr($date, 4, 2), substr($date, 6, 2), substr($date, 0, 4)));')
      );
      $aColumnWidths = false;
      $sSQLquery = "SELECT id, field_1, field_2, field_3 FROM `news_data` WHERE `active` = 1 AND news_id = ".$iID;
      $sEditAction = "show|||./newsmodul.html?form_action=show&id=".$iID."&action=edit&fid=<id>";
      $sDeleteAction = "show|||javascript:if(confirm('Wollen Sie diesen Eintrag wirklich löschen?'))
document.location.href='./newsmodul.html?form_action=show&id=".$iID."&action=delete&fid=<id>';";
      $aButtons = array("hinzuf&uuml;gen||newsmodul.html?form_action=show&action=edit&id=".$iID,"zur&uuml;ck||newsmodul.html" );
      $sDefaultOrder = "field_1 DESC";
      $iPerPage = 20;
      $bShowTopNavi = false;



      // News-Liste ausgeben
      printTableList(
        $sHeadline,
        $aColumnNames,
        $aDBColumnNames,
        $aColumnWidths,
        $sSQLquery,
        $sEditAction,
        $sDeleteAction,
        $aButtons,
        $aColumnAligns='',
        $aColumnFunctions,			// ='',
        $asAdvancedSQLQuery='',
        $sDefaultOrder,				// ='',
        $iPerPage,					// =0,
        $bNoWrap=false,
        $sGetParam="&form_action=show&id=".$iID,
        $aPostParam='',
        $bNewWindow=false,
        $bShowTopNavi,				// =true,
        $sDatabase=false
      );
    }}
  elseif("edit" == $sTodo)
  {
    if($_VARS['item']=="speichern"){
      // Falls keine ID vorgegeben ist, wird ein neuer Eintrag erstellt.
      if(!$iID){
        $sSQL= "" .
          "INSERT INTO news_init (id, name, expire, min, max, active)" .
          "VALUES ('', '".\DB::escapeQueryString($_VARS['name'])."', '".\DB::escapeQueryString($_VARS['expire'])."', '".\DB::escapeQueryString($_VARS['min'])."', '".\DB::escapeQueryString($_VARS['max'])."', '1' )";
        echo "QUERY:".$sSQL;
        db_query($sSQL);
        $iID=get_insert_id();
      }
      if($iID) {
          $sSQL= "
            SELECT *
            FROM `news_options`
            WHERE `news_id` = ".$iID."
            AND `active` = 1";
          $rRes = db_query($sSQL);

        while($aMyData=get_data($rRes))
        {
          $temp="field_".$aMyData['id'];
          $temp2="fieldalias_".$aMyData['id'];
          $sSQL= "
          UPDATE `news_options`
          SET `name` = '".$_VARS[$temp]."',
          `tagname` = '".$_VARS[$temp2]."'
          WHERE `id` = ".$aMyData['id'];
          db_query($sSQL);
        }

        $sSQL= "
          UPDATE `news_init`" .
          "SET `name` = '".$_VARS['name']."'," .
          "`expire` = '".$_VARS['expire']."'," .
          "`min` = '".$_VARS['min']."'," .
          "`max` = '".$_VARS['max']."'" .
          "WHERE `id` = ".$iID;
        db_query($sSQL);
        // Neue Felder anlegen
        if($_VARS['newfieldtext']&&$_VARS['newfieldtype']){
          $sSQL=
          "INSERT INTO `news_options` (id, news_id, type, name, tagname, active)".
          "VALUES ('', '".$iID."', '".$_VARS['newfieldtype']."', '".$_VARS['newfieldtext']."', '".$_VARS['newfieldalias']."', 1)";
          db_query($sSQL);

          if($_VARS['newfieldtype']=="date")
          {
            $type="TIMESTAMP";
          }
          else
          {
            $type="TEXT";
          }
          $sSQL=
          "ALTER TABLE `news_data` ADD `field_".get_insert_id()."` ".$type." NOT NULL;";
          db_query($sSQL);

        }

      }
    }

    $sSQL= 	"SELECT * FROM news_init WHERE id = ".$iID ." AND `active` = 1";
    $result_init=get_data(db_query($sSQL));

    // Tabelle erstellen
    ?><form name="formular" method="POST" action="<?=$_SERVER["PHP_SELF"] . "?" . rand(0, 100000);?>" enctype="multipart/form-data"><?
	if($item=="neues Feld"){$result_init['name']=$_VARS['name'];$result_init['expire']=$_VARS['expire'];$result_init['min']=$_VARS['min'];$result_init['max']=$_VARS['max']; }
    printTableStart();
      printFormText("Name", "name", $result_init['name']);
      printFormText("Wieviele Tage soll die News angezeigt werden?", "expire", $result_init['expire']);
      printFormText("Wieviele News sollen minimal angezeigt werden?", "min", $result_init['min']);
      printFormText("Wieviele News sollen maximal angezeigt werden?", "max", $result_init['max']);
      echo "<tr><th colspan=\"2\">zusätzliche Felder:</th></tr>";
      if($iID)
      {
        // Felder löschen
        if($_VARS['item']=="delete")
        {
        $sSQL= "
          UPDATE `news_options`
          SET `active` = 0
          WHERE `id` = ".$_VARS['fid'];
        }
        db_query($sSQL);

        // Zusätzliche Felder
        $sSQL= "
          SELECT *
          FROM `news_options`
          WHERE `news_id` = ".$iID."
          AND `active` = 1
          ORDER BY id";
        $rRes = db_query($sSQL);
        while($aMyData=get_data($rRes))
        {
          printFormOptionalText("Feld ".$aMyData['id']." (".$aMyData['type'].")", "field_".$aMyData['id'], $aMyData['name'], "", $aMyData['id']);
          // Falls das Feld editiert werden soll
          echo "<input type=\"hidden\" id=\"".$aMyData['id']."\" name=\"fieldalias_".$aMyData['id']."\" value=\"".$aMyData['tagname']."\">";
        }
      }

      // Falls ein neues Feld angelegt werden soll
      if($item=="neues Feld"){
        printFormText("neues Feld - Kurzbeschreibung", "newfieldtext");
        printFormSelect("neues Feld - Type", "newfieldtype", array("text"=>"Text", "html"=>"HTML", "image"=>"Image", "date"=>"Datum"));
        printFormText("neues Feld - Alias", "newfieldalias");
      }
      echo
        "<tr>" .
        "<td colspan=\"2\" align=\"center\">" .
          "<input type=\"hidden\" name=form_action value=edit>" .
          "<input type=hidden name=id value=".$iID.">";
      // Nur Feld hinzufügen zeigen wenns nötig ist
      if(!($item=="neues Feld"))
      {
      echo	"<input type=submit name=\"item\" value=\"neues Feld\">" .
          "&nbsp;&nbsp;&nbsp;";
      }
      echo"<input type=submit name=\"item\" value=\"speichern\">" .
          "&nbsp;&nbsp;&nbsp;" .
          "<input type=button value=\"back\" onclick=\"location='newsmodul.html'\">" .
        "</td>" .
        "</tr>";
    printTableEnd();
    echo "</form>";
  }


  else{
    // Eintrag löschen
    if($iID && "delete" == $sTodo)
    {
      $sSQL =	"UPDATE `news_init` SET `active` = '0' WHERE `id` = ".$iID;
      db_query($sSQL);
      $sSQL =	"UPDATE `news_data` SET `active` = '0' WHERE `news_id` = ".$iID;
      db_query($sSQL);
      $sSQL =	"UPDATE `news_options` SET `active` = '0' WHERE `news_id` = ".$iID;
      db_query($sSQL);
    }
    // News-Liste konfigurieren
    $sHeadline = "";
    $aColumnNames = array(
      "Name",
      "Aktion"
    );
    $aDBColumnNames = array(
      "id",
      "name"

    );
    $aColumnFunctions = array();
    $aColumnWidths = false;
    $sSQLquery = "SELECT id, name FROM `news_init` WHERE `active` = 1";
    $sEditAction = "show";
    $sDeleteAction = "delete";
    $aButtons = array("hinzuf&uuml;gen|edit");
    $sDefaultOrder = "name";
    $iPerPage = 20;
    $bShowTopNavi = false;


    // News-Liste ausgeben
    printTableList(
      $sHeadline,
      $aColumnNames,
      $aDBColumnNames,
      $aColumnWidths,
      $sSQLquery,
      $sEditAction,
      $sDeleteAction,
      $aButtons,
      $aColumnAligns='',
      $aColumnFunctions,			// ='',
      $asAdvancedSQLQuery='',
      $sDefaultOrder,				// ='',
      $iPerPage,					// =0,
      $bNoWrap=false,
      $sGetParam,
      $aPostParam='',
      $bNewWindow=false,
      $bShowTopNavi,				// =true,
      $sDatabase=false
    );
  }
}
?>
		</td>
	</tr>
</table>
<?=Admin_Html::loadAdminFooter()?>

