<?

require_once(Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");
include_once(\Util::getDocumentRoot()."system/extensions/office/office.inc.php");

Admin_Html::loadAdminHeader();

addSystemRight('office_tickets_light', 'Office » Tickets light', 'office');

Access_Backend::checkAccess("office_tickets_light");

$objTickets = new Ext_Office_TicketsLight();

// Check the configuration
$bTable = $bKey = $bValue = false;
$sSQL = "
	SELECT
		*
	FROM
		`office_ticket_light_config`
";
$aResult = DB::getQueryData($sSQL);

foreach((array)$aResult as $iKey => $aValue)
{
	if($aValue['variable'] == 'customer_table' && !empty($aValue['value']))
	{
		$bTable = true;
	}
	if($aValue['variable'] == 'customer_key' && !empty($aValue['value']))
	{
		$bKey = true;
	}
	if($aValue['variable'] == 'customer_value' && !empty($aValue['value']))
	{
		$bValue = true;
	}
}

// Configurate the 'office_ticket_config'
if(!$bTable)
{
	$sSQL = "INSERT INTO `office_ticket_light_config` SET `variable` = 'customer_table', `value` = 'customer_db_".$aConfigData['database']."'";
	DB::executeQuery($sSQL);
}
if(!$bKey)
{
	$sSQL = "INSERT INTO `office_ticket_light_config` SET `variable` = 'customer_key', `value` = 'id'";
	DB::executeQuery($sSQL);
}
if(!$bValue)
{
	$sSQL = "INSERT INTO `office_ticket_light_config` SET `variable` = 'customer_value', `value` = '".$aConfigData['field_matchcode']."'";
	DB::executeQuery($sSQL);
}

$sSql = "CREATE TABLE IF NOT EXISTS `office_ticket_light_comments` (
		  `id` int(11) NOT NULL auto_increment,
		  `changed` timestamp NOT NULL,
		  `created` timestamp NOT NULL default '0000-00-00 00:00:00',
		  `active` tinyint(1) NOT NULL default '1',
		  `ticket_id` int(11) NOT NULL default '0',
		  `user_id` int(11) NOT NULL default '0',
		  `comment` text NOT NULL,
		  PRIMARY KEY  (`id`),
		  KEY `ticket_id` (`ticket_id`),
		  KEY `user_id` (`user_id`)
		) TYPE=MyISAM";
DB::executeQuery($sSql);

/**
 * Frontend configuration
 */
if ($_VARS['page_id'] && $_VARS['element_id'] && $_VARS['content_id']) {

	if ($_POST['action'] == "config") {
		$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
		$config->assigned_user_id = $_VARS['assigned_user_id'];
		$config->save_config($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);
	}
	$config = new \Cms\Helper\ExtensionConfig($_VARS['page_id'], $_VARS['element_id'], $_VARS['content_id'], $_VARS['language']);

	$aUsers = $objTickets->getUserList();
?>

<?=Admin_Html::loadAdminHeader()?>

<table cellpadding="0" cellspacing="30" border="0" width="100%" height="100%">
    <tr>
        <td valign="top">

			<h1>Office &raquo; Dokumente</h1>


			<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<?=printFormHidden('action', 'config')?>
			<?=printFormHidden('page_id', $_VARS['page_id'])?>
			<?=printFormHidden('element_id', $_VARS['element_id'])?>
			<?=printFormHidden('content_id', $_VARS['content_id'])?>
			<?=printFormHidden('language', $_VARS['language'])?>
			<?=printTableStart()?>
			<?=printFormSelect("Bearbeiter", "assigned_user_id", $aUsers, $config->assigned_user_id)?>
			<?=printTableEnd()?>
			<?=printSubmit("Konfiguration speichern")?>
			</form>


		</td>
	</tr>
</table>

<?=Admin_Html::loadAdminFooter()?>

<?
	die();
}
?>

<table width="100%" cellpadding="30" cellspacing="0" border="0">
	<tr>
		<td>

<?
if($_VARS['task'] == 'edit') {

	if(isset($_VARS['id'])) {
		$arrTicket = $objTickets->getTicket($_VARS['id']);
	}

?>

			<h1>Ticketsystem &raquo; Ticket editieren</h1>

			<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<input type="hidden" name="task" value="save"/>
			<input type="hidden" name="id" value="<?=$_VARS['id']?>"/>
			<?=printTableStart()?>
				<?=printFormSelect("Kunde", "customer_id", $objTickets->getCustomers(), $arrTicket['customer_id'])?>
				<?=printFormDate("Fälligkeitsdatum", "due_date", $arrTicket['due_date'])?>
				<?=printFormSelect("Priorität", "priority", $objTickets->getPriorities(), $arrTicket['priority'])?>
				<?=printFormSelect("Status", "state", $objTickets->getStates(), $arrTicket['state'])?>
				<?=printFormSelect("Bearbeiter", "assigned_user_id", $objTickets->getUserList(), $arrTicket['assigned_user_id'])?>
				<?=printFormText("Titel", "headline", $arrTicket['headline'])?>
				<?=printFormTextarea("Beschreibung", "description", $arrTicket['description'], 20)?>
			<?=printTableEnd()?>
			<?=printSubmit("Ticket speichern")?>
			</form>
			<p align="right">
				<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>';" class="btn">zurück</button>
			</p>
<?
} elseif($_VARS['task'] == 'detail') {

	$arrTicketData = $objTickets->getTicket($_VARS['id']);
	$arrTicket = $objTickets->getTicketDisplay($arrTicketData);

	if(
		isset($_VARS['comment']) &&
		!empty($_VARS['comment'])
	) {
		$objTickets->addComment($arrTicket['id'], $_VARS['comment']);
		$objTickets->sendMessage($arrTicket['id'], true);
	}

	$arrComments = $objTickets->getComments($arrTicket['id']);

?>

			<h1>Ticketsystem &raquo; Ticket Details</h1>

			<?=printTableStart()?>
				<tr>
					<th>Erstellungsdatum</th>
					<td><?=\Util::convertHtmlEntities(strftime("%x %X", $arrTicket['created']))?></td>
				</tr>
				<tr>
					<th>Letzte Änderung</th>
					<td><?=\Util::convertHtmlEntities(strftime("%x %X", $arrTicket['changed']))?></td>
				</tr>
				<tr>
					<th>Kunde</th>
					<td><?=\Util::convertHtmlEntities($arrTicket['customer'])?></td>
				</tr>
				<tr>
					<th>Fälligkeitsdatum</th>
					<td><?=\Util::convertHtmlEntities(strftime("%x %X", $arrTicket['due_date']))?></td>
				</tr>
				<tr>
					<th>Status</th>
					<td><?=\Util::convertHtmlEntities($arrTicket['state'])?></td>
				</tr>
				<tr>
					<th>Priorität</th>
					<td><?=\Util::convertHtmlEntities($arrTicket['priority'])?></td>
				</tr>
				<tr>
					<th>Bearbeiter</th>
					<td><?=\Util::convertHtmlEntities($arrTicket['assigned_user'])?></td>
				</tr>
				<tr>
					<th>Berichtet von</th>
					<td><?=\Util::convertHtmlEntities($arrTicket['creator_user'])?></td>
				</tr>
				<tr>
					<th>Titel</th>
					<td><?php if (strlen($arrTicket['headline']) < 1) { echo '&nbsp;'; } else { echo \Util::convertHtmlEntities($arrTicket['headline']); } ?></td>
				</tr>
				<tr>
					<th>Beschreibung</th>
					<td><?php if (strlen($arrTicket['description']) < 1) { echo '&nbsp;'; } else { echo nl2br(\Util::convertHtmlEntities($arrTicket['description'])); } ?></td>
				</tr>
			<?=printTableEnd()?>

			<p align="right">
				<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>?task=edit&id=<?=$arrTicket['id']?>';" class="btn">Ticket bearbeiten</button>
<?
				if(
					$arrTicket['assigned_user_id'] == $user_data['id'] &&
					(
						$arrTicketData['state'] == 'new'
					)
				) {
?>
				&nbsp;<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>?task=state&state=confirmed&id=<?=$arrTicket['id']?>';" class="btn">Ticket bestätigen</button>
<?
				}
?>
<?
				if(
					$arrTicket['assigned_user_id'] == $user_data['id'] &&
					(
						$arrTicketData['state'] == 'confirmed'
					)
				) {
?>
				&nbsp;<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>?task=state&state=done&id=<?=$arrTicket['id']?>';" class="btn">Ticket als erledigt markieren</button>
<?
				}
?>
<?
				if(
					$arrTicket['creator_user_id'] == $user_data['id'] &&
					$arrTicketData['state'] == 'done'
				) {
?>
				&nbsp;<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>?task=state&state=closed&id=<?=$arrTicket['id']?>';" class="btn">Ticket schliessen</button>
<?
				}
?>
			</p>
			
			<h2>Kommentare</h2>
			<table cellpadding="4" cellspacing="0" border="0" width="100%" class="table">
				<colgroup>
					<col style="width: 130px;"/>
					<col style="width: 130px;"/>
					<col style="width: auto;"/>
				</colgroup>
				<tr>
					<th>Von</th>
					<th>Datum</th>
					<th>Kommentar</th>
				</tr>
<?
				foreach((array)$arrComments as $aComment) {
?>
				<tr>
					<td style="vertical-align: top;"><?=$aComment['firstname']?> <?=$aComment['lastname']?></td>
					<td style="vertical-align: top;"><?=strftime("%x %X", $aComment['created'])?></td>
					<td style="vertical-align: top;"><?=nl2br(\Util::convertHtmlEntities($aComment['comment']))?></td>
				</tr>
<?
				}
?>
			</table>
			<br/>
			<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<input type="hidden" name="task" value="detail"/>
			<input type="hidden" name="id" value="<?=(int)$_VARS['id']?>"/>
			<?=printTableStart()?>
				<?=printFormTextarea("Kommentar", "comment", "", 10, 'style="width: 400px;"')?>
			<?=printTableEnd()?>
			<p align="right">
				<input type="submit" class="btn" value="Kommentar speichern" />
			</p>
			</form>

			<p align="right">
				<button onClick="location.href='<?=$_SERVER['PHP_SELF']?>';" class="btn">zurück</button>
			</p>

<?
} else {

	if($_VARS['task'] == 'save') {
		
		$intTicketId = $objTickets->saveTicket($_VARS);
		$objTickets->sendMessage($intTicketId);

	} elseif($_VARS['task'] == 'state') {
		
		$arrTicket = $objTickets->getTicket($_VARS['id']);
		
		if($_VARS['state'] == 'confirmed' && $arrTicket['assigned_user_id'] == $user_data['id']) {
			$objTickets->setTicketState($_VARS['id'], 'confirmed');
		}

		if($_VARS['state'] == 'done' && $arrTicket['assigned_user_id'] == $user_data['id']) {
			$objTickets->setTicketState($_VARS['id'], 'done');
		}
		
		if($_VARS['state'] == 'closed' && $arrTicket['creator_user_id'] == $user_data['id']) {
			$objTickets->setTicketState($_VARS['id'], 'closed');
		}
		
		$objTickets->sendMessage($_VARS['id']);
		
	}

	if(isset($_VARS['assigned_user_id'])) {
		$_SESSION['office']['tickets']['assigned_user_id'] = (int)$_VARS['assigned_user_id'];
	}

	if(isset($_SESSION['office']['tickets']['assigned_user_id'])) {
		$iAssignedUserId = $_SESSION['office']['tickets']['assigned_user_id'];
	} else {
		$iAssignedUserId = $user_data['id'];
	}

?>

				<h1>Ticketsystem &raquo; Übersicht</h1>
			
				<div class="infoBox">
					<h1>Aktionen</h1>
      				<ul>
      					<li><a href="<?=$_SERVER['PHP_SELF']?>?task=edit">Neues Ticket anlegen</a></li>
      				</ul>
            	</div>
				<br/><br/>
      			<table width="100%" cellpadding="0" cellspacing="0" border="0">
        			<colgroup>
          				<col width="50%">
          				<col width="20">
          				<col width="50%">
					</colgroup>
        			<tr>
          				<td valign="top"">
							<h2>Mir zugewiesen 
  <select name="name" onchange="go('<?=$_SERVER['PHP_SELF']?>?assigned_user_id='+this.value);">
<?

	foreach((array)$objTickets->getUserList() as $iUser=>$sUser) {
		echo '<option value="'.$iUser.'" '.(($iUser==$iAssignedUserId)?'selected="selected"':'').'>'.$sUser.'</option>';
	}

?>
  </select>
  </h2>




            	<?
            	$arrOptions = array("state"=>"new", "assigned_user_id"=>$iAssignedUserId);
            	echo $objTickets->writeTicketBox("Neue Tickets", $arrOptions);
            	?>
            	
            	<?
            	$arrOptions = array("state"=>"confirmed", "assigned_user_id"=>$iAssignedUserId);
            	echo $objTickets->writeTicketBox("Best&auml;tigte Tickets", $arrOptions);
            	?>

            	<?
            	$arrOptions = array("state"=>"done", "assigned_user_id"=>$iAssignedUserId);
            	echo $objTickets->writeTicketBox("Erledigte Tickets", $arrOptions);
            	?>

          	</td>
          	<td><img src="/admin/media/spacer.gif" width="20" height="1" border="0"></td>
			<td valign=top>
				<h2>Von mir berichtet</h2>

            	<?
            	$arrOptions = array("state"=>"new", "creator_user_id"=>$user_data['id']);
            	echo $objTickets->writeTicketBox("Neue Tickets", $arrOptions);
            	?>
            	
            	<?
            	$arrOptions = array("state"=>"confirmed", "creator_user_id"=>$user_data['id']);
            	echo $objTickets->writeTicketBox("Bestätigte Tickets", $arrOptions);
            	?>

            	<?
            	$arrOptions = array("state"=>"done", "creator_user_id"=>$user_data['id']);
            	echo $objTickets->writeTicketBox("Erledigte Tickets", $arrOptions);
            	?>



          </td>
        </tr>
      </table>
      
<?
}
?>
      
    </td>
  </tr>
</table>


<?=Admin_Html::loadAdminFooter()?>
