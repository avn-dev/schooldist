<?php	

require_once(Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

/**
 * Daten vorbereiten 
 */
$aLanguages	= Ext_TC_Factory::executeStatic('Ext_TC_Util', 'getTranslationLanguages');

$sSubObjectLabel = Ext_TC_Factory::executeStatic('Ext_TC_Object', 'getSubObjectLabel');
$aSubObjects = Ext_TC_Factory::executeStatic('Ext_TC_Object', 'getSubObjects', array(true));

$oWDBasic = Ext_TC_Factory::getClassName('Ext_TC_Referrer');

$aSubObjectLanguages = Ext_TC_Referrer::getSubObjectsLanguages('tc_r_i18n');

/**
 * GUI Objekt aufbauen 
 */
$oGui = new Ext_TC_Gui2(md5('tc_referrers'), 'Ext_TC_Referrer_Gui2_Data');
$oGui->access = array('core_marketing_referrers', '');
$oGui->calendar_format = Ext_TC_Factory::getObject('Ext_TC_Gui2_Format_Date');
$oGui->include_jquery = true;
$oGui->include_jquery_multiselect = true;
$oGui->class_js	= 'ReferrersGui';

$oGui->row_sortable = 1;

$oGui->setWDBasic($oWDBasic);
$oGui->setTableData('orderby', array('tc_r_i18n.name' => 'ASC'));

// Dialog

$oDialog = $oGui->createDialog($oGui->t('Referenz editieren'), $oGui->t('Referenz anlegen'));
$oDialog->save_as_new_button = true;
$oDialog->save_bar_options = true;
$oDialog->aOptions['section'] = 'admin_referrers';

$oDialog->setElement($oDialog->createRow($sSubObjectLabel, 'select', array(
	'db_alias' => 'tc_r',
	'db_column' => 'objects',
	'multiple' => 5, 
	'jquery_multiple' => 1,
	'select_options' => $aSubObjects,
	'required' => 1,
	'searchable' => 1,
	'child_visibility' => $aSubObjectLanguages
)));

$oDialog->setElement($oDialog->createI18NRow($oGui->t('Name'), array(
	'db_alias' => 'tc_r_i18n',
	'db_column'=> 'name',
	'i18n_parent_column' => 'referrer_id',
	'required' => true	
), $aLanguages));

if(Ext_TC_Util::getSystem() === 'agency') {

    $oDialog->setElement($oDialog->createRow($oGui->t('Textfeld'), 'checkbox', array(
    	'db_alias' => 'tc_r',
    	'db_column' => 'textfields',
    	'child_visibility' => array(
    		array(
    			'id' => 'joinedobjectcontainer_fields',
    			'on_values' => array(
    				'1'
    			)
    		)
    	)
    )));

	$oJoinContainer = $oDialog->createJoinedObjectContainer('fields', array('min' => 1, 'max' => 20));

	$oJoinContainer->setElement($oJoinContainer->createRow($oGui->t('Feld'), 'select', array(
		'db_alias' => 'tc_rf',
		'db_column' => 'field',
		'selection' => new Ext_TC_Referrer_Selection_Field(),
		'class'	=> 'field_select',
		'dependency' => array(
			array(
				'db_alias' => 'tc_rf',
				'db_column' => 'field'
			)
		),
		'events' => array(
			array(
				'event' => 'change',
				'function' => 'prepareJoinedObjectLabel',
				'parameter' => '$(sId)'
			)
		)
	)));

	$oJoinContainer->setElement($oJoinContainer->createRow($oGui->t('Pflichtfeld'), 'checkbox', array(
		'db_alias' => 'tc_rf',
		'db_column' => 'required'
	)));

	$oJoinContainer->setElement($oJoinContainer->createRow($oGui->t('Label'), 'input', array(
		'db_alias' => 'tc_rf',
		'db_column' => 'label'
	)));

	$oDialog->setElement($oJoinContainer);

}

// Filter

$oBar = $oGui->createBar();

$oFilter = $oBar->createFilter();
$oFilter->db_column = array('name');
$oFilter->db_alias = array('tc_r_i18n');
$oFilter->db_operator = 'LIKE';
$oFilter->id = 'search';
$oFilter->placeholder = $oGui->t('Suche').'…';
$oBar->setElement($oFilter);

$oBar->setElement($oBar->createSeperator());

$oFilter = $oBar->createValidFilter($oGui->t('Gültigkeit'));
$oBar->setElement($oFilter);

$oGui->setBar($oBar);

//Icon

$oBar = $oGui->createBar();

$oIcon = $oBar->createNewIcon($oGui->t('Neuer Eintrag'), $oDialog, $oGui->t('Neuer Eintrag'));
$oBar->setElement($oIcon);

$oIcon = $oBar->createEditIcon($oGui->t('Editieren'), $oDialog, $oGui->t('Editieren'));
$oBar->setElement($oIcon);

$oIcon = $oBar->createDeleteIcon($oGui->t('Löschen'), $oGui->t('Löschen'));
$oBar->setElement($oIcon);

$oIcon = $oBar->createDeactivateIcon($oGui->t('Deaktivieren'), $oGui->t('Deaktivieren'));
$oBar->setElement($oIcon);

$oGui->setBar($oBar);

// Loading/Pagination

$oBar = $oGui->createBar();
$oPagination = $oBar->createPagination(true);
$oBar->setElement($oPagination);
$oLoading = $oBar->createLoadingIndicator();
$oBar->setElement($oLoading);
$oGui->setBar($oBar);

// List 

$oGui->addLanguageColumns($aLanguages, 'name', 'tc_r_i18n', $oGui->t('Name'), true);

if(Ext_TC_Util::getSystem() === 'agency') {
	$oColumn = $oGui->createColumn();
	$oColumn->db_column = 'textfields';
	$oColumn->db_alias = 'tc_r';
	$oColumn->title = $oGui->t('Textfeld');
	$oColumn->width = Ext_TC_Util::getTableColumnWidth('short_name');
	$oColumn->width_resize = false;
	$oColumn->format = new Ext_TC_Gui2_Format_YesNo();
	$oGui->setColumn($oColumn);
}

$oColumn = $oGui->createColumn();
$oColumn->db_alias = '';
$oColumn->db_column = 'subobjects';
$oColumn->title = Ext_TC_Factory::executeStatic('Ext_TC_Object', 'getSubObjectLabel');
$oColumn->width = Ext_TC_Util::getTableColumnWidth('name');
$oColumn->format = new Ext_TC_Gui2_Format_Multiselect($aSubObjects);
$oColumn->width_resize = false;
$oColumn->inplaceEditor = 0;
$oGui->setColumn($oColumn);

$oGui->addDefaultColumns();

//------------------------------------------------------------------------------

$aOptional = array();
$aOptional['js'][]	= '/admin/extensions/tc/js/referrers.js';

$oGui->display($aOptional);


