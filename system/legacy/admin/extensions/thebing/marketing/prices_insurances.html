<?php


ob_start();

include(\Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Ext_Thebing_Access::accesschecker("thebing_marketing_prices");

$oSchool = Ext_Thebing_School::getSchoolFromSession();
$sDefaultLang = $oSchool->getLanguage();

$aPeriods = $oSchool->getSaisonList(true, 0, 0, 0, 0, 0, 1);

/**
 *  Wenn keine Saison übergeben wurde hole die default Saison und setzte diese in die VARS
 */
if(!$_VARS['idPeriod']){
	$aSaison = $oSchool->getCurrentSaison(false, false, false, false, false, false, true);
	$_VARS['idPeriod'] = $aSaison['id'];
}

// Setzt $_VARS['sCurrency'] und $_VARS['currency_id']
$oCurrency = new Ext_Thebing_Currency_Util($oSchool);
$aCurrency = $oCurrency->getCurrencyList(true);

// $_VARS['sCurrency'] und $_VARS['currency_id'] von Ext_Thebing_Currency_Util nicht mehr verwenden, da Schrott
if(empty($_VARS['currency'])) {
	$sCurrencyIso = key($aCurrency);
} else {
	$sCurrencyIso = $_VARS['currency'];
}
$iCurrencyId = $oCurrency->getCurrencyByIso($sCurrencyIso)['id'];

$oSaison = new Ext_Thebing_Saison($oSchool);

$oPrice = new Ext_Thebing_Price($oSchool,$oSaison,$oCurrency);
$oPrice->useFallback = false;

switch($_VARS['func'])
{
	case 'save':
	{
		$_VARS = $oPrice->convertPriceFloatInputs($_VARS);

		/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */

		$oPrice->saveInsurancePrices(
			$_VARS['insurance'],
			false,
			(int)$_VARS['idPeriod'],
			$iCurrencyId
		);

		break;	
	}

	default: break;
}

echo Admin_Html::loadAdminHeader();

$aInsurancePrices = $oPrice->getInsurancePricesList((int)$_VARS['idPeriod'], $iCurrencyId, 'Thebing » Marketing » Prices', '');

?>

<style>
	.not-available,
	.txt.amount.not-available {
		color: #999999;
	}
	.amount {
		text-align: right;
		width: 75px;
	}
	.table > tbody > tr > td,
	.table > tbody > tr > th {
		line-height: 32px;
	}
	.table {
		width: initial;
	}
</style>

<section class="content-header">
	<h1><?=Ext_TS_System_Navigation::t()?></h1>
</section>

<form method="post" name="prices" action="<?=$_SERVER['PHP_SELF']?>" onkeydown="if (event.keyCode == 13) return false;">
	
	<section class="content">
	
		<div class="box">
			<div class="box-body table-responsive">
				
			<input type="hidden" name="task" value="">
			<input type="hidden" name="func" value="">
			<table cellpadding="5" cellspacing="0" class="table" style="width:100%;">
				<?=printFormSelect(L10N::t('Saison','Thebing » Marketing » Prices'), 'idPeriod', $aPeriods, $_VARS['idPeriod'], "onchange=\"document.prices.task.value=''; document.prices.submit();\" style=\"width: 300px;\"")?>
				<?=printFormSelect(L10N::t('Währung','Thebing » Marketing » Prices'), 'currency', $aCurrency, $sCurrencyIso, "onchange=\"document.prices.task.value=''; document.prices.submit();\" style=\"width: 300px;\"")?>
			</table>
		
			</div>
		</div>

		<div class="box">
			<div class="box-header with-border">
				<h3 class="box-title"><?=Ext_Thebing_L10N::t('Versicherungskosten','','Thebing » Marketing » Prices');?></h3>
            </div>
			<div class="box-body table-responsive">
			

		<table class="table table-striped table-hover">
			<? foreach((array)$aInsurancePrices as $aInsurance) { ?>
				<tr>
					<th colspan="2">
						<?=$aInsurance['name_'. $sDefaultLang]?>
					</th>
				</tr>
				<? foreach((array)$aInsurance['weeks'] as $aWeek) { ?>
					<tr>
						<td><?=$aWeek['title']?></td>
						<td>
							<input type="text" class="txt form-control" name="insurance[<?=$aInsurance['id']?>][<?=$aWeek['id']?>][<?=$aWeek['price_id']?>]" value="<?=Ext_Thebing_Format::Number($aWeek['price'], null, null, true, 5)?>" />
						</td>
					</tr>
				<? } ?>
			<? } ?>
		</table>
			</div>
		</div>
		
		
		
			<br/>
			<button class="btn btn-primary pull-right" onclick="document.prices.func.value='save'; document.prices.submit();"><?=Ext_Thebing_L10N::t('Speichern','','Thebing » Marketing » Prices')?></button>
			<br/><br/>

	</section>
	
</form>


<?php
$sAdditional = "";
echo Admin_Html::loadAdminFooter($sAdditional);
?>