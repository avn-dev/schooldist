<?php

require_once(Util::getDocumentRoot()."system/legacy/admin/includes/main.inc.php");

Ext_Thebing_Access::accesschecker("thebing_tuition_examination_sections");

// Daten
$oSchool		= Ext_Thebing_School::getSchoolFromSession();
$iSchoolId		= $oSchool->id;
$aEntityTypes	= Ext_Thebing_Examination_Sections::getEntityTypes(true);

//SectionsCategory
$oGuiCategory = new Ext_Thebing_Gui2(md5('thebing_tuition_examination_sections_categories'), \TsTuition\Gui2\Data\Examination\SectionCategories::class);

$oGuiCategory->setWDBasic('Ext_Thebing_Examination_SectionCategory');
$oGuiCategory->setTableData('where', array('kexsc.active' => 1));
$oGuiCategory->setTableData('limit', 30);
$oGuiCategory->setTableData('orderby', array('kexsc.name' => 'ASC'));

// Listenoptionen
$oGuiCategory->column_sortable		= 1;
$oGuiCategory->row_sortable			= 0;
$oGuiCategory->multiple_selection	= 0;
$oGuiCategory->query_id_column		= 'id';
$oGuiCategory->query_id_alias		= 'kexsc';

// Dialog
$oDialog					= $oGuiCategory->createDialog(L10N::t("Kategorie \"{name}\" editieren", $oGuiCategory->gui_description), L10N::t('Neue Kategorie anlegen', $oGuiCategory->gui_description));
$oDialog->width				= 900;
$oDialog->height			= 650;
$oDialog->save_as_new_button = true;

$oDialog->setElement($oDialog->createRow($oGuiCategory->t('Name'), 'input', array(
	'db_alias'			=> 'kexsc',
	'db_column'			=> 'name',
	'required'			=> 1,
)));

$oDialog->setElement(
	$oDialog->createRow(
		$oGuiCategory->t('Schulen'),
		'select',
		[
			'db_alias' => 'kexsc',
			'db_column' => 'schools',
			'multiple' => 5,
			'select_options' => \Ext_Thebing_Client::getSchoolList(true),
			'jquery_multiple' => 1,
			'searchable' => 1,
			'required' => 1,
		]
	)
);

// Toggle
$oBar						= $oGuiCategory->createBar();
$oBar->width				= '100%';

// Suche

$oFilter					= $oBar->createFilter();
$oFilter->db_column			= array('id', 'name');
$oFilter->db_alias			= array('kexsc', 'kexsc');
$oFilter->db_operator		= 'LIKE';
$oFilter->id				= 'search';
$oFilter->placeholder		= $oGuiCategory->t('Suche').'…';
$oBar->setElement($oFilter);
$oGuiCategory->setBar($oBar);

// Buttons
$oBar			= $oGuiCategory->createBar();
$oBar->width	= '100%';
$oIcon			= $oBar->createNewIcon($oGuiCategory->t('Neuer Eintrag'), $oDialog, $oGuiCategory->t('Neuer Eintrag'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createEditIcon($oGuiCategory->t('Editieren'), $oDialog, $oGuiCategory->t('Editieren'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createDeleteIcon($oGuiCategory->t('Löschen'), $oGuiCategory->t('Löschen'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createCopyIcon($oGuiCategory->t('Duplizieren'), $oGuiCategory->t('Duplizieren'));
$oBar->setElement($oIcon);
$oGuiCategory->setBar($oBar);


// Paginator
$oBar						= $oGuiCategory->createBar();
$oBar->width				= '100%';
$oBar->position				= 'top';
$oPagination				= $oBar->createPagination();
$oBar->setElement($oPagination);
$oLoading					= $oBar->createLoadingIndicator();
$oBar->setElement($oLoading);
$oGuiCategory->setBar($oBar);

//Spalten
$oColumn				= $oGuiCategory->createColumn();
$oColumn->db_column		= 'name';
$oColumn->db_alias		= 'kexsc';
$oColumn->title			= $oGuiCategory->t('Name');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('name');
$oColumn->width_resize	= true;
$oGuiCategory->setColumn($oColumn);

$oColumn				= $oGuiCategory->createColumn();
$oColumn->db_column		= 'school_id';
$oColumn->db_alias		= 'schools';
$oColumn->select_column = 'schools';
$oColumn->title			= $oGuiCategory->t('Schulen');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('long_description');
$oColumn->format = new \Ts\Gui2\School\MultiSelectFormat;
$oGuiCategory->setColumn($oColumn);

$oGuiCategory->addDefaultColumns();


//Sections
$oGui = new Ext_Thebing_Gui2(md5('thebing_tuition_examination_sections'), 'Ext_Thebing_Examination_Sections_Gui2');
$oGui->gui_description	= $oGuiCategory->gui_description;
$oGuiData = $oGui->getDataObject(); /** @var $oGuiData Ext_Thebing_Examination_Sections_Gui2 */

$oGui->setWDBasic('Ext_Thebing_Examination_Sections');
$oGui->setTableData('where', array('kexs.active' => 1));
$oGui->setTableData('orderby', array('kexs.title' => 'ASC'));

// Listenoptionen
$oGui->gui_title			= $oGui->t('Prüfungsbereiche');
$oGui->column_sortable		= 1;
$oGui->row_sortable			= 1;
$oGui->multiple_selection	= 0;
$oGui->query_id_column		= 'id';
$oGui->query_id_alias		= 'kexs';
$oGui->class_js				= 'Examsection';

// Dialog
$oDialog					= $oGui->createDialog(L10N::t("Prüfungsbereich \"{title}\" editieren", $oGui->gui_description), L10N::t('Neuen Prüfungsbereich anlegen', $oGui->gui_description));
$oDialog->width				= 900;
$oDialog->height			= 650;

$oDialog->save_as_new_button		= true;
$oDialog->save_bar_options			= true;
$oDialog->save_bar_default_option	= 'new';

$oTabData = $oDialog->createTab($oGui->t('Daten'));


$oTabData->setElement($oDialog->createRow($oGui->t('Bezeichnung'), 'input', array(
		'db_alias'			=> '',
		'db_column'			=> 'title',
		'required'			=> 1,
)));


$oTabData->setElement($oDialog->createRow($oGui->t('Beschreibung'), 'textarea', array(
		'db_alias'			=> '',
		'db_column'			=> 'description',
		'required'			=> 0,
)));

$oTabData->setElement($oDialog->createRow($oGui->t('Art'), 'select', array(
		'db_alias'			=> '',
		'db_column'			=> 'entity_type_id',
		'required'			=> 1,
		'select_options'	=> $aEntityTypes,
)));

$oTabData->setElement($oDialog->createRow($oGui->t('Kommentar'), 'textarea', array(
		'db_alias'			=> '',
		'db_column'			=> 'comment',
		'required'			=> 0,
)));

$oDialog->setElement($oTabData);

// Options GUI (für Select)
$oTabOptions = $oDialog->createTab($oGui->t('Optionen'));
$oTabOptions->setElement($oGuiData->getOptionGui());

$oDialog->setElement($oTabOptions);

// Toggle
$oBar						= $oGui->createBar();
$oBar->width				= '100%';

// Suche
$oFilter					= $oBar->createFilter();
$oFilter->db_column			= array('id', 'title');
$oFilter->db_alias			= array('kexs', 'kexs');
$oFilter->db_operator		= 'LIKE';
$oFilter->id				= 'search';
$oFilter->placeholder		= $oGui->t('Suche').'…';
$oBar->setElement($oFilter);
$oGui->setBar($oBar);

// Buttons
$oBar			= $oGui->createBar();
$oBar->width	= '100%';
$oIcon			= $oBar->createNewIcon($oGui->t('Neuer Eintrag'), $oDialog, $oGui->t('Neuer Eintrag'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createEditIcon($oGui->t('Editieren'), $oDialog, $oGui->t('Editieren'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createDeleteIcon($oGui->t('Löschen'), $oGui->t('Löschen'));
$oBar->setElement($oIcon);
$oIcon			= $oBar->createCopyIcon($oGui->t('Duplizieren'), $oGui->t('Duplizieren'));
$oBar->setElement($oIcon);
$oGui->setBar($oBar);


// Paginator
$oBar						= $oGui->createBar();
$oBar->width				= '100%';
$oBar->position				= 'top';
$oPagination				= $oBar->createPagination(true);
$oBar->setElement($oPagination);
$oLoading					= $oBar->createLoadingIndicator();
$oBar->setElement($oLoading);
$oGui->setBar($oBar);

//Spalten
$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'title';
$oColumn->db_alias		= 'kexs';
$oColumn->title			= $oGui->t('Bezeichnung');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('name');
$oColumn->width_resize	= true;
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'entity_type';
$oColumn->db_alias		= '';
$oColumn->title			= $oGui->t('Art');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('name');
$oColumn->width_resize	= true;
$oColumn->format		= new Ext_Thebing_Gui2_Format_Translate($oGui->gui_description);
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'description';
$oColumn->db_alias		= 'kexs';
$oColumn->title			= $oGui->t('Beschreibung');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('comment');
$oColumn->width_resize	= false;
$oColumn->css_overflow	= true;
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'comment';
$oColumn->db_alias		= 'kexs';
$oColumn->title			= $oGui->t('Kommentar');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('comment');
$oColumn->width_resize	= false;
$oColumn->css_overflow	= true;
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'user_id';
$oColumn->db_alias		= 'kexs';
$oColumn->title			= $oGui->t('Bearbeiter');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('name');
$oColumn->width_resize	= false;
$oColumn->format		= new Ext_Gui2_View_Format_UserName(true);
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'created';
$oColumn->db_alias		= 'kexs';
$oColumn->db_type		= 'timestamp';
$oColumn->title			= $oGui->t('Erstellt');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('date');
$oColumn->format		= new Ext_Thebing_Gui2_Format_Date_DateTime();
$oGui->setColumn($oColumn);

$oColumn				= $oGui->createColumn();
$oColumn->db_column		= 'changed';
$oColumn->db_alias		= 'kexs';
$oColumn->db_type		= 'timestamp';
$oColumn->title			= $oGui->t('Verändert');
$oColumn->width			= Ext_Thebing_Util::getTableColumnWidth('date');
$oColumn->format		= new Ext_Thebing_Gui2_Format_Date_DateTime();
$oGui->setColumn($oColumn);

$aOptionalInfo['js'][]	= '/admin/extensions/thebing/tuition/js/examsection.js';

$oPage = new Ext_TS_Gui2_Page();
$oPage->setGui($oGuiCategory);
$oPage->setGui($oGui,		array('hash' => $oGuiCategory->hash, 'foreign_key' => 'section_category_id', 'parent_primary_key' => 'id', 'reload' => true));

$oPage->display($aOptionalInfo);